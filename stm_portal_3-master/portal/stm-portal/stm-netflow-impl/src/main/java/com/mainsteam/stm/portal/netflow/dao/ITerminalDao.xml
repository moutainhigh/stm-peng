<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
        
<mapper namespace="com.mainsteam.stm.portal.netflow.dao.ITerminalDao">
	
	
	<select id="getAllTerminals" resultType="com.mainsteam.stm.portal.netflow.bo.TerminalBo" parameterType="com.mainsteam.stm.platform.mybatis.plugin.pagination.Page">
							select terminal_name,in_flows,in_packages,out_flows,out_packages,total_flows,total_packages,in_speed,out_speed,total_speed,flows_rate,
							flows_rate flowPctge,packets_rate packetPctge,connects_rate connectPctge,
							connectNumberIn,connectNumberOut,connectNumberTotal,
							connectNumberInSpeed,connectNumberOutSpeed,connectNumberTotalSpeed,
							packetInSpeed,packetOutSpeed,packetTotalSpeed
							 from (
								select src_ip as terminal_name,ifnull(in_flows,0) as in_flows,ifnull(in_packages,0) in_packages,
								ifnull(out_flows,0) as out_flows, ifnull(out_packages,0) as out_packages,
								ifnull(in_flows,0)+ifnull(out_flows,0) as total_flows,
								ifnull(in_packages,0)+ifnull(out_packages,0) as total_packages,
								ifnull(in_flows,0)/${condition.timepart} as in_speed,
								ifnull(out_flows,0)/${condition.timepart} as out_speed,
								ifnull(in_flows,0)/${condition.timepart}+ifnull(out_flows,0)/${condition.timepart} as total_speed,
								(ifnull(in_flows,0)+ifnull(out_flows,0))/${condition.allterminalsFlows} as flows_rate,
								(ifnull(in_packages,0)+ifnull(out_packages,0))/${condition.wholePackets} as packets_rate,
								(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${condition.wholeConnects} as connects_rate,
								ifnull(connectNumberIn,0) connectNumberIn,ifnull(connectNumberOut,0) connectNumberOut,ifnull(ifnull(connectNumberIn,0) + ifnull(connectNumberOut,0),0) connectNumberTotal,
								ifnull(connectNumberIn/${condition.timepart},0) connectNumberInSpeed,ifnull(connectNumberOut/${condition.timepart},0) connectNumberOutSpeed,ifnull((ifnull(connectNumberIn,0) + ifnull(connectNumberOut,0))/${condition.timepart},0) connectNumberTotalSpeed,
								ifnull(in_packages/${condition.timepart},0) packetInSpeed,ifnull(out_packages/${condition.timepart},0) packetOutSpeed,ifnull((ifnull(in_packages,0)+ifnull(out_packages,0))/${condition.timepart},0) packetTotalSpeed
								from (
								
									select src_ip,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
									from (
										(
											select src_ip, sum(out_flows) as out_flows,sum(out_packages) as out_packages,sum(connectNumberOut) connectNumberOut from
											(
											select src_ip,sum(octets_total) as out_flows,sum(packet_total) as out_packages,SUM(FLOW_TOTAL) AS connectNumberOut
											from ANA_IF_IN_NET_APP_TOS_${condition.tableSubfixTime} 
											<if test="condition!=null">
											<trim prefix="where" prefixOverrides="and |or ">
							           		 <if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
							           		 <if test="condition.if_id != null"> AND if_in_id = #{condition.if_id}</if>
							           		 <if test="condition.app_id != null"> AND app_id = #{condition.app_id}</if>
							           		 <if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
							           		 </trim>
							           		 </if>
											 group by src_ip
											union all
											select src_ip,sum(octets_total) as out_flows,sum(packet_total) as out_packages,SUM(FLOW_TOTAL) AS connectNumberOut
											from ANA_IF_OUT_NET_APP_TOS_${condition.tableSubfixTime}
											<if test="condition!=null">
											<trim prefix="where" prefixOverrides="and |or ">
							           		 <if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
							           		  <if test="condition.if_id != null"> AND if_out_id = #{condition.if_id}</if>
							           		 <if test="condition.app_id != null"> AND app_id = #{condition.app_id}</if>
							           		 <if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
							           		 </trim>
							           		 </if>
											group by src_ip
											) t
											group by src_ip
										) t1 left join 
								
										(
											select dst_ip, sum(in_flows) as in_flows,sum(in_packages) as in_packages,sum(connectNumberIn) connectNumberIn from
											(
											select dst_ip,sum(octets_total) as in_flows,sum(packet_total) as in_packages,SUM(FLOW_TOTAL) AS connectNumberIn
											from ANA_IF_IN_NET_APP_TOS_${condition.tableSubfixTime}
											<if test="condition!=null">
											<trim prefix="where" prefixOverrides="and |or ">
							           		 <if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
							           		  <if test="condition.if_id != null"> AND if_in_id = #{condition.if_id}</if>
							           		 <if test="condition.app_id != null"> AND app_id = #{condition.app_id}</if>
							           		 <if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
							           		 </trim>
							           		 </if>
										    group by dst_ip
											union all
											select dst_ip,sum(octets_total) as in_flows,sum(packet_total) as in_packages,SUM(FLOW_TOTAL) AS connectNumberIn
											from ANA_IF_OUT_NET_APP_TOS_${condition.tableSubfixTime} 
											<if test="condition!=null">
											<trim prefix="where" prefixOverrides="and |or ">
							           		 <if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
							           		  <if test="condition.if_id != null"> AND if_out_id = #{condition.if_id}</if>
							           		 <if test="condition.app_id != null"> AND app_id = #{condition.app_id}</if>
							           		 <if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
							           		 </trim>
							           		 </if>
											 group 	by dst_ip
											) t
											group by dst_ip
										)t2  on t1.src_ip = t2.dst_ip
									)
									union 
									select dst_ip,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
									from (
								
										(
											select src_ip, sum(out_flows) as out_flows,sum(out_packages) as out_packages,SUM(connectNumberOut) AS connectNumberOut from
											(
											select src_ip,sum(octets_total) as out_flows,sum(packet_total) as out_packages,SUM(FLOW_TOTAL) AS connectNumberOut
											from ANA_IF_IN_NET_APP_TOS_${condition.tableSubfixTime} 
											<if test="condition!=null">
											<trim prefix="where" prefixOverrides="and |or ">
							           		 <if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
							           		  <if test="condition.if_id != null"> AND if_in_id = #{condition.if_id}</if>
							           		 <if test="condition.app_id != null"> AND app_id = #{condition.app_id}</if>
							           		 <if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
							           		 </trim>
							           		 </if>
											group by src_ip
											union all
											select src_ip,sum(octets_total) as out_flows,sum(packet_total) as out_packages,SUM(FLOW_TOTAL) AS connectNumberOut
											from ANA_IF_OUT_NET_APP_TOS_${condition.tableSubfixTime}
											<if test="condition!=null">
											<trim prefix="where" prefixOverrides="and |or ">
							           		 <if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
							           		  <if test="condition.if_id != null"> AND if_out_id = #{condition.if_id}</if>
							           		 <if test="condition.app_id != null"> AND app_id = #{condition.app_id}</if>
							           		 <if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
							           		 </trim>
							           		 </if>
											group by src_ip
											) t
											group by src_ip
										) t1 right join 
										(
											select dst_ip, sum(in_flows) as in_flows,sum(in_packages) as in_packages,SUM(connectNumberIn) AS connectNumberIn from
											(
											select dst_ip,sum(octets_total) as in_flows,sum(packet_total) as in_packages,SUM(FLOW_TOTAL) AS connectNumberIn
											from ANA_IF_IN_NET_APP_TOS_${condition.tableSubfixTime}
											<if test="condition!=null">
											<trim prefix="where" prefixOverrides="and |or ">
							           		 <if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
							           		  <if test="condition.if_id != null"> AND if_in_id = #{condition.if_id}</if>
							           		 <if test="condition.app_id != null"> AND app_id = #{condition.app_id}</if>
							           		 <if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
							           		 </trim>
							           		 </if>
											group by dst_ip
											union all
											select dst_ip,sum(octets_total) as in_flows,sum(packet_total) as in_packages,SUM(FLOW_TOTAL) AS connectNumberIn
											from ANA_IF_OUT_NET_APP_TOS_${condition.tableSubfixTime}
											<if test="condition!=null">
											<trim prefix="where" prefixOverrides="and |or ">
							           		 <if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
							           		  <if test="condition.if_id != null"> AND if_out_id = #{condition.if_id}</if>
							           		 <if test="condition.app_id != null"> AND app_id = #{condition.app_id}</if>
							           		 <if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
							           		 </trim>
							           		 </if>
											group by dst_ip
											) t
											group by dst_ip
										)t2  on t1.src_ip = t2.dst_ip
									)
								
								) t3 
							) t4  
							<if test="condition.terminal_name != null">
								where 1=1 and t4.terminal_name like concat('%',#{condition.terminal_name},'%')
							</if>
							order by ${condition.sort}  ${condition.order}
	</select>
	
	<select id="getAllTerminalsFlows" resultType="com.mainsteam.stm.portal.netflow.bo.Whole" parameterType="com.mainsteam.stm.portal.netflow.bo.TerminalConditionBo">
							
											select sum(ifnull(in_flows,0) +ifnull(out_flows,0)) as wholeFlows,
												   sum(ifnull(in_packages,0) +ifnull(out_packages,0)) as wholePackets,
												   sum(ifnull(connectNumberIn,0) +ifnull(connectNumberOut,0)) as wholeConnects
												from (
												
													select src_ip,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
													from (
														(
															select src_ip, sum(out_flows) as out_flows,sum(out_packages) as out_packages,
															SUM(connectNumberOut) connectNumberOut
															from
															(
															select src_ip,sum(octets_total) as out_flows,sum(packet_total) as out_packages,
															SUM(FLOW_TOTAL) connectNumberOut 
															from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime}
															
															<trim prefix="where" prefixOverrides="and |or ">
											           		   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           		   <if test="if_id != null"> AND if_out_id = #{if_id}</if>
							           		 					<if test="app_id != null"> AND app_id = #{app_id}</if>
											           		 <if test="starttime != null"> AND ACQ_TIME <![CDATA[ > ]]>#{stime}</if>
															<if test="endtime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
											           		 </trim>
											           	
											           		 
															group by src_ip
															union all
															select src_ip,sum(octets_total) as out_flows,sum(packet_total) as out_packages,
															SUM(FLOW_TOTAL) connectNumberOut
															from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}
															<trim prefix="where" prefixOverrides="and |or ">
											           		   <if test="deviceIp != null"> AND router_ip = #{deviceIp}</if>
											           		   <if test="if_id != null"> AND if_out_id = #{if_id}</if>
							           		 				<if test="app_id != null"> AND app_id = #{app_id}</if>
											           		 <if test="starttime != null"> AND ACQ_TIME <![CDATA[ > ]]>#{stime}</if>
															<if test="endtime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
											           		 </trim>
															group by src_ip
															) t
															group by src_ip
														) t1 left join 
												
														(
															select dst_ip, sum(in_flows) as in_flows,sum(in_packages) as in_packages,
															SUM(connectNumberIn) connectNumberIn
															from
															(
															select dst_ip,sum(octets_total) as in_flows,sum(packet_total) as in_packages,
															SUM(FLOW_TOTAL) connectNumberIn
															from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime}
															<trim prefix="where" prefixOverrides="and |or ">
											           		   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           		   <if test="if_id != null"> AND if_out_id = #{if_id}</if>
							           		 				<if test="app_id != null"> AND app_id = #{app_id}</if>
											           		 <if test="starttime != null"> AND ACQ_TIME <![CDATA[ > ]]>#{stime}</if>
															<if test="endtime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
											           		 </trim>
															group by dst_ip
															union all
															select dst_ip,sum(octets_total) as in_flows,sum(packet_total) as in_packages,
															SUM(FLOW_TOTAL) connectNumberIn 
															from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}
															<trim prefix="where" prefixOverrides="and |or ">
											           		   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           		   <if test="if_id != null"> AND if_out_id = #{if_id}</if>
							           		 				<if test="app_id != null"> AND app_id = #{app_id}</if>
											           		 <if test="starttime != null"> AND ACQ_TIME <![CDATA[ > ]]>#{stime}</if>
															<if test="endtime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
											           		 </trim>
															group by dst_ip
															) t
															group by dst_ip
														)t2  on t1.src_ip = t2.dst_ip
													)
													union 
													select dst_ip,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
													from (
												
														(
															select src_ip, sum(out_flows) as out_flows,sum(out_packages) as out_packages,
															SUM(connectNumberOut) connectNumberOut
															from
															(
															select src_ip,sum(octets_total) as out_flows,sum(packet_total) as out_packages,
															SUM(FLOW_TOTAL) connectNumberOut
															from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime} 
															<trim prefix="where" prefixOverrides="and |or ">
											           		   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           		   <if test="if_id != null"> AND if_out_id = #{if_id}</if>
							           		 				<if test="app_id != null"> AND app_id = #{app_id}</if>
											           		 <if test="starttime != null"> AND ACQ_TIME <![CDATA[ > ]]>#{stime}</if>
															<if test="endtime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
											           		 </trim>
															group by src_ip
															union all
															select src_ip,sum(octets_total) as out_flows,sum(packet_total) as out_packages,
															SUM(FLOW_TOTAL) connectNumberOut
															from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}
														<trim prefix="where" prefixOverrides="and |or ">
											           		   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           		   <if test="if_id != null"> AND if_out_id = #{if_id}</if>
							           		 				<if test="app_id != null"> AND app_id = #{app_id}</if>
											           		 <if test="starttime != null"> AND ACQ_TIME <![CDATA[ > ]]>#{stime}</if>
															<if test="endtime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
											           		 </trim>
															group by src_ip
															) t
															group by src_ip
														) t1 right join 
														(
															select dst_ip, sum(in_flows) as in_flows,sum(in_packages) as in_packages,
															SUM(connectNumberIn) connectNumberIn
															from
															(
															select dst_ip,sum(octets_total) as in_flows,sum(packet_total) as in_packages,
															SUM(FLOW_TOTAL) connectNumberIn
															from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime}
															<trim prefix="where" prefixOverrides="and |or ">
											           		   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           		   <if test="if_id != null"> AND if_out_id = #{if_id}</if>
							           		 				<if test="app_id != null"> AND app_id = #{app_id}</if>
											           		 <if test="starttime != null"> AND ACQ_TIME <![CDATA[ > ]]>#{stime}</if>
															<if test="endtime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
											           		 </trim>
															group by dst_ip
															union all
															select dst_ip,sum(octets_total) as in_flows,sum(packet_total) as in_packages,
															SUM(FLOW_TOTAL) connectNumberIn 
															from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}
															<trim prefix="where" prefixOverrides="and |or ">
											           		   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           		   <if test="if_id != null"> AND if_out_id = #{if_id}</if>
							           		 					<if test="app_id != null"> AND app_id = #{app_id}</if>
											           		 	<if test="starttime != null"> AND ACQ_TIME <![CDATA[ > ]]>#{stime}</if>
																<if test="endtime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
											           		 </trim>
															group by dst_ip
															) t
															group by dst_ip
														)t2  on t1.src_ip = t2.dst_ip
													)
												
												) t3 
						
	</select>
	
	<select id="getAllTerminalChartData" resultType="com.mainsteam.stm.portal.netflow.bo.TerminalBo" parameterType="com.mainsteam.stm.portal.netflow.bo.TerminalConditionBo">
							
													select acq_time,ifnull(in_flows,0) as in_flows,ifnull(in_packages,0) in_packages,
															ifnull(out_flows,0) as out_flows, ifnull(out_packages,0) as out_packages,
															ifnull(in_flows,0)+ifnull(out_flows,0) as total_flows,
															ifnull(in_packages,0)+ifnull(out_packages,0) as total_package,
															ifnull(in_flows,0)/${timepart} as in_speed,
															ifnull(out_flows,0)/${timepart} as out_speed,
															ifnull(in_flows,0)/${timepart}+ifnull(out_flows,0)/${timepart} as total_speed,
															(ifnull(in_flows,0)+ifnull(out_flows,0))/${allterminalsFlows} as flows_rate,
															ifnull(in_packages/${timepart},0) packetInSpeed,ifnull(out_flows/${timepart},0) packetOutSpeed,ifnull((ifnull(in_packages,0)+ifnull(out_flows,0))/${timepart},0) packetTotalSpeed,
															ifnull(connectNumberIn,0) connectNumberIn,ifnull(connectNumberOut,0) connectNumberOut,ifnull(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0),0) connectNumberTotal,
															ifnull(connectNumberIn/${timepart},0) connectNumberInSpeed,ifnull(connectNumberOut/${timepart},0) connectNumberOutSpeed,ifnull((ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${timepart},0) connectNumberTotalSpeed
															from (
															
																select t1.acq_time,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
																from (
																	(
																		select acq_time, sum(out_flows) as out_flows,sum(out_packages) as out_packages,
																		SUM(connectNumberOut) AS connectNumberOut from
																		(
																		select acq_time,sum(octets_total) as out_flows,sum(packet_total) as out_packages,
																		SUM(FLOW_TOTAL) AS connectNumberOut
																		from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime} 
																			<trim prefix="where" prefixOverrides="and |or ">
															           		   <if test="currentTerminals != null"> AND src_ip = #{currentTerminals}</if>
															           		   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
															           		   <if test="if_id != null"> AND if_in_id = #{if_id}</if>
												           		 				<if test="app_id != null"> AND app_id = #{app_id}</if>
																           		<if test="timePoints!=null">
																           			 and acq_time in 
																					 <foreach collection="timePoints" item="time" index="index"
																			            open="(" close=")" separator=",">
																			            #{time}
																			        </foreach> 
																			           		</if>
															           		 </trim> 
																	
																		group by acq_time
																		union all
																		select acq_time,sum(octets_total) as out_flows,sum(packet_total) as out_packages,
																		SUM(FLOW_TOTAL) AS connectNumberOut
																		from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime} 
																		<trim prefix="where" prefixOverrides="and |or ">
															           		   <if test="currentTerminals != null"> AND src_ip = #{currentTerminals}</if>
															           		   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
															           		   <if test="if_id != null"> AND if_out_id = #{if_id}</if>
												           		 				<if test="app_id != null"> AND app_id = #{app_id}</if>
																           		<if test="timePoints!=null">
																           			 and acq_time in 
																					 <foreach collection="timePoints" item="time" index="index"
																			            open="(" close=")" separator=",">
																			            #{time}
																			        </foreach> 
																			           		</if>
															           		 </trim> 
																		group by acq_time
																		) t
																		group by acq_time
																	) t1 left join 
															
																	(
																		select acq_time, sum(in_flows) as in_flows,sum(in_packages) as in_packages,SUM(connectNumberIn) AS connectNumberIn from
																		(
																		select acq_time,sum(octets_total) as in_flows,sum(packet_total) as in_packages,
																		SUM(FLOW_TOTAL) AS connectNumberIn
																		from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime} 
																		<trim prefix="where" prefixOverrides="and |or ">
															           		   <if test="currentTerminals != null"> AND dst_ip = #{currentTerminals}</if>
															           		   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
															           		   <if test="if_id != null"> AND if_in_id = #{if_id}</if>
												           		 				<if test="app_id != null"> AND app_id = #{app_id}</if>
																           		<if test="timePoints!=null">
																           			 and acq_time in 
																					 <foreach collection="timePoints" item="time" index="index"
																			            open="(" close=")" separator=",">
																			            #{time}
																			        </foreach> 
																			           		</if>
															           		 </trim> 
																		group by acq_time
																		union all
																		select acq_time,sum(octets_total) as in_flows,sum(packet_total) as in_packages,
																		SUM(FLOW_TOTAL) AS connectNumberIn
																		from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime} 
																		<trim prefix="where" prefixOverrides="and |or ">
															           		   <if test="currentTerminals != null"> AND dst_ip = #{currentTerminals}</if>
															           		   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
															           		   <if test="if_id != null"> AND if_out_id = #{if_id}</if>
												           		 				<if test="app_id != null"> AND app_id = #{app_id}</if>
																           		<if test="timePoints!=null">
																           			 and acq_time in 
																					 <foreach collection="timePoints" item="time" index="index"
																			            open="(" close=")" separator=",">
																			            #{time}
																			        </foreach> 
																			           		</if>
															           		 </trim> 
																		group by acq_time
																		) t
																		group by acq_time
																	)t2  on t1.acq_time = t2.acq_time
																)
																union 
																select t2.acq_time,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
																from (
															
																	(
																		select acq_time, sum(out_flows) as out_flows,sum(out_packages) as out_packages,
																		SUM(connectNumberOut) AS connectNumberOut from
																		(
																		select acq_time,sum(octets_total) as out_flows,sum(packet_total) as out_packages,
																		SUM(FLOW_TOTAL) AS connectNumberOut 
																		from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime} 
																		<trim prefix="where" prefixOverrides="and |or ">
															           		   <if test="currentTerminals != null"> AND src_ip = #{currentTerminals}</if>
															           		   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
															           		   <if test="if_id != null"> AND if_in_id = #{if_id}</if>
												           		 				<if test="app_id != null"> AND app_id = #{app_id}</if>
																           		<if test="timePoints!=null">
																           			 and acq_time in 
																					 <foreach collection="timePoints" item="time" index="index"
																			            open="(" close=")" separator=",">
																			            #{time}
																			        </foreach> 
																			           		</if>
															           		 </trim> 
																		group by acq_time
																		union all
																		select acq_time,sum(octets_total) as out_flows,sum(packet_total) as out_packages,
																		SUM(FLOW_TOTAL) AS connectNumberOut
																		from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}
																		<trim prefix="where" prefixOverrides="and |or ">
															           		   <if test="currentTerminals != null"> AND src_ip = #{currentTerminals}</if>
															           		   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
															           		   <if test="if_id != null"> AND if_out_id = #{if_id}</if>
												           		 				<if test="app_id != null"> AND app_id = #{app_id}</if>
																           		<if test="timePoints!=null">
																           			 and acq_time in 
																					 <foreach collection="timePoints" item="time" index="index"
																			            open="(" close=")" separator=",">
																			            #{time}
																			        </foreach> 
																			           		</if>
															           		 </trim> 
																		group by acq_time
																		) t
																		group by acq_time
																	) t1 right join 
																	(
																		select acq_time, sum(in_flows) as in_flows,sum(in_packages) as in_packages,
																		SUM(connectNumberIn) AS connectNumberIn from
																		(
																		select acq_time,sum(octets_total) as in_flows,sum(packet_total) as in_packages,
																		SUM(FLOW_TOTAL) AS connectNumberIn
																		from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime}
																		<trim prefix="where" prefixOverrides="and |or ">
															           		   <if test="currentTerminals != null"> AND dst_ip = #{currentTerminals}</if>
															           		   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
															           		   <if test="if_id != null"> AND if_in_id = #{if_id}</if>
												           		 				<if test="app_id != null"> AND app_id = #{app_id}</if>
																           		<if test="timePoints!=null">
																           			 and acq_time in 
																					 <foreach collection="timePoints" item="time" index="index"
																			            open="(" close=")" separator=",">
																			            #{time}
																			        </foreach> 
																			           		</if>
															           		 </trim> 
																		group by acq_time
																		union all
																		select acq_time,sum(octets_total) as in_flows,sum(packet_total) as in_packages,
																		SUM(FLOW_TOTAL) AS connectNumberIn
																		from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime} 
																		<trim prefix="where" prefixOverrides="and |or ">
															           		   <if test="currentTerminals != null"> AND dst_ip = #{currentTerminals}</if>
															           		   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
															           		   <if test="if_id != null"> AND if_out_id = #{if_id}</if>
												           		 				<if test="app_id != null"> AND app_id = #{app_id}</if>
																           		<if test="timePoints!=null">
																           			 and acq_time in 
																					 <foreach collection="timePoints" item="time" index="index"
																			            open="(" close=")" separator=",">
																			            #{time}
																			        </foreach> 
																			           		</if>
															           		 </trim> 
																		group by acq_time
																		) t
																		group by acq_time
																	)t2  on t1.acq_time = t2.acq_time
																)
															
															) t3  order by acq_time asc
						
	</select>
	
	
	
	
	
	
	<select id="getappbyterminal" resultType="com.mainsteam.stm.portal.netflow.bo.TerminalBo" parameterType="com.mainsteam.stm.platform.mybatis.plugin.pagination.Page">
					
					select app_name,app_id,in_flows,in_packages,out_flows,out_packages,total_flows,total_packages,in_speed,out_speed,total_speed,flows_rate,
					flows_rate flowPctge,packetPctge,connectPctge,
					packetInSpeed,packetOutSpeed,packetTotalSpeed,
					connectNumberIn,connectNumberOut,connectNumberTotal,
					connectNumberInSpeed,connectNumberOutSpeed,connectNumberTotalSpeed
					from (
								
							select name as app_name,id as app_id,ifnull(in_flows,0) as in_flows,ifnull(in_packages,0) as in_packages,
							ifnull(out_flows,0) as out_flows,ifnull(out_packages,0) as out_packages, 
							ifnull(in_flows,0)+ifnull(out_flows,0) as total_flows,
							ifnull(in_packages,0)+ifnull(out_packages,0) as total_packages,
							ifnull(in_flows,0)/${condition.timepart} as in_speed,
							ifnull(out_flows,0)/${condition.timepart} as out_speed,
							ifnull(in_flows,0)/${condition.timepart}+ifnull(out_flows,0)/${condition.timepart} as total_speed,
							(ifnull(in_flows,0)+ifnull(out_flows,0))/${condition.allapplicationflows} as flows_rate,
							(ifnull(in_packages,0)+ifnull(out_packages,0))/${condition.wholePackets} as packetPctge,
							(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${condition.wholeConnects} as connectPctge,
							ifnull(in_packages,0)/${condition.timepart} packetInSpeed,ifnull(out_packages,0)/${condition.timepart} packetOutSpeed,(ifnull(in_packages,0)+ifnull(out_packages,0))/${condition.timepart} packetTotalSpeed,
							ifnull(connectNumberIn,0) connectNumberIn,ifnull(connectNumberOut,0) connectNumberOut ,ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0) connectNumberTotal,
							ifnull(connectNumberIn,0)/${condition.wholeConnects} connectNumberInSpeed,ifnull(connectNumberOut,0)/${condition.wholeConnects} connectNumberOutSpeed ,(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${condition.wholeConnects} connectNumberTotalSpeed
							from 
								(
								select t1.name,t1.id,ifnull(in_flows,0) as in_flows,ifnull(in_packages,0) as in_packages,ifnull(out_flows,0) as out_flows,ifnull(out_packages,0) as out_packages,
								ifnull(connectNumberIn,0) as connectNumberIn,ifnull(connectNumberOut,0) as connectNumberOut
								from
								(
									(
										select g.name,g.id,sum(octets_total) as in_flows,sum(packet_total) as in_packages,
										SUM(FLOW_TOTAL) connectNumberIn
										from CONF_APPLICATION_GROUP g left join 	
										CONF_APPLICATION_GROUP_MAP m on g.id = m.app_group_id left join CONF_APPLICATION a
										on m.app_id = a.id left join ANA_IF_IN_NET_APP_TOS_${condition.tableSubfixTime}  f on a.id = f.app_id 
										<trim prefix="where" prefixOverrides="and |or ">
										<if test="condition.terminal_name != null"> AND (f.src_ip = #{condition.terminal_name}</if>
										<if test="condition.terminal_name != null"> OR f.dst_ip = #{condition.terminal_name})</if>
										<if test="condition.stime != null"> AND f.ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
										<if test="condition.etime != null"> AND f.ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
										 </trim>
										group by g.id 
									) t1 left join 
							
									(
									select g.name,g.id,sum(octets_total) as out_flows,sum(packet_total) as out_packages,
									SUM(FLOW_TOTAL) connectNumberOut
									from CONF_APPLICATION_GROUP g left join 		
									CONF_APPLICATION_GROUP_MAP m on g.id = m.app_group_id left join CONF_APPLICATION a
									on m.app_id = a.id left join ANA_IF_OUT_NET_APP_TOS_${condition.tableSubfixTime} f on a.id = f.app_id 
									<trim prefix="where" prefixOverrides="and |or ">
										<if test="condition.terminal_name != null"> AND (f.src_ip = #{condition.terminal_name}</if>
										<if test="condition.terminal_name != null"> OR f.dst_ip = #{condition.terminal_name})</if>
										<if test="condition.stime != null"> AND f.ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
										<if test="condition.etime != null"> AND f.ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
								  </trim>
									group by g.id
									) t2 on t1.id = t2.id
								)
								union
								select t2.name,t2.id,ifnull(in_flows,0) as in_flows,ifnull(in_packages,0) as in_packages,ifnull(out_flows,0) as out_flows,ifnull(out_packages,0) as out_packages,
								SUM(connectNumberIn) connectNumberIn,SUM(connectNumberOut) connectNumberOut
								from
								(
									(
										select g.name,g.id,sum(octets_total) as in_flows,sum(packet_total) as in_packages,
										SUM(FLOW_TOTAL) connectNumberIn
										from CONF_APPLICATION_GROUP g left join 	
										CONF_APPLICATION_GROUP_MAP m on g.id = m.app_group_id left join CONF_APPLICATION a
										on m.app_id = a.id left join ANA_IF_IN_NET_APP_TOS_${condition.tableSubfixTime} f on a.id = f.app_id 
										<trim prefix="where" prefixOverrides="and |or ">
										<if test="condition.terminal_name != null"> AND (f.src_ip = #{condition.terminal_name}</if>
										<if test="condition.terminal_name != null"> OR f.dst_ip = #{condition.terminal_name})</if>
										<if test="condition.stime != null"> AND f.ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
										<if test="condition.etime != null"> AND f.ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
								  		</trim>
										group by g.id 
									) t1 right join 
							
									(
									select g.name,g.id,sum(octets_total) as out_flows,sum(packet_total) as out_packages,
									SUM(FLOW_TOTAL) connectNumberOut
									from CONF_APPLICATION_GROUP g left join 		
									CONF_APPLICATION_GROUP_MAP m on g.id = m.app_group_id left join CONF_APPLICATION a
									on m.app_id = a.id left join ANA_IF_OUT_NET_APP_TOS_${condition.tableSubfixTime} f on a.id = f.app_id 
										<trim prefix="where" prefixOverrides="and |or ">
										<if test="condition.terminal_name != null"> AND (f.src_ip = #{condition.terminal_name}</if>
										<if test="condition.terminal_name != null"> OR f.dst_ip = #{condition.terminal_name})</if>
										<if test="condition.stime != null"> AND f.ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
										<if test="condition.etime != null"> AND f.ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
								  		</trim>
									group by g.id
									) t2 on t1.id = t2.id
								)
							)t3 
					) t4 order by ${condition.sort}  ${condition.order}
	</select>
	
	<select id="getappflowsbyterminal" resultType="com.mainsteam.stm.portal.netflow.bo.Whole" parameterType="com.mainsteam.stm.portal.netflow.bo.TerminalConditionBo">
									select 
									  sum(ifnull(in_flows,0)+ifnull(out_flows,0)) as wholeFlows,sum(ifnull(in_packages,0)+ifnull(out_packages,0)) as wholePackets,sum(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0)) as wholeConnects
									from 
										(
									
										select t1.name,ifnull(in_flows,0) as in_flows,ifnull(in_packages,0) as in_packages,ifnull(out_flows,0) as out_flows,ifnull(out_packages,0) as out_packages,
										ifnull(connectNumberIn,0) connectNumberIn,ifnull(connectNumberOut,0) connectNumberOut
										from
										(
											(
												select g.name,g.id,sum(octets_total) as in_flows,sum(packet_total) as in_packages,
												SUM(FLOW_TOTAL) connectNumberIn
												from CONF_APPLICATION_GROUP g left join 		
												CONF_APPLICATION_GROUP_MAP m on g.id = m.app_group_id left join CONF_APPLICATION a
												on m.app_id = a.id  left join ANA_IF_IN_NET_APP_TOS_${tableSubfixTime} f on a.id = f.app_id 
												<trim prefix="where" prefixOverrides="and |or ">
												<if test="terminal_name != null"> AND (f.src_ip = #{terminal_name}</if>
												<if test="terminal_name != null"> OR f.dst_ip = #{terminal_name})</if>
												  <if test="starttime != null"> AND f.ACQ_TIME <![CDATA[ > ]]>#{stime}</if>
												 <if test="endtime != null"> AND f.ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
										      </trim>
												group by g.id 
											) t1 left join 
									
											(
											select g.name,g.id,sum(octets_total) as out_flows,sum(packet_total) as out_packages,
											SUM(FLOW_TOTAL) connectNumberOut
											from CONF_APPLICATION_GROUP g left join 			   
											CONF_APPLICATION_GROUP_MAP m on g.id = m.app_group_id left join CONF_APPLICATION a
											on m.app_id = a.id left join ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime} f on a.id = f.app_id 
											<trim prefix="where" prefixOverrides="and |or ">
												<if test="terminal_name != null"> AND (f.src_ip = #{terminal_name}</if>
												<if test="terminal_name != null"> OR f.dst_ip = #{terminal_name})</if>
												  <if test="starttime != null"> AND f.ACQ_TIME <![CDATA[ > ]]>#{stime}</if>
												 <if test="endtime != null"> AND f.ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
										      </trim>
											group by g.id
											) t2 on t1.id = t2.id
										)
										union
										select t2.name,ifnull(in_flows,0)as in_flows,ifnull(in_packages,0) as in_packages,ifnull(out_flows,0) as out_flows,ifnull(out_packages,0) as out_packages,
										ifnull(connectNumberIn,0) connectNumberIn,ifnull(connectNumberOut,0) connectNumberOut
										from
										(
											(
												select g.name,g.id,sum(octets_total) as in_flows,sum(packet_total) as in_packages,SUM(FLOW_TOTAL) connectNumberIn from CONF_APPLICATION_GROUP g left join 		
												CONF_APPLICATION_GROUP_MAP m on g.id = m.app_group_id left join CONF_APPLICATION a
												on m.app_id = a.id left join ANA_IF_IN_NET_APP_TOS_${tableSubfixTime} f on a.id = f.app_id 
												<trim prefix="where" prefixOverrides="and |or ">
												<if test="terminal_name != null"> AND (f.src_ip = #{terminal_name}</if>
												<if test="terminal_name != null"> OR f.dst_ip = #{terminal_name})</if>
												  <if test="starttime != null"> AND f.ACQ_TIME <![CDATA[ > ]]>#{stime}</if>
												 <if test="endtime != null"> AND f.ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
										      </trim>
												group by g.id 
											) t1 right join 
									
											(
											select g.name,g.id,sum(octets_total) as out_flows,sum(packet_total) as out_packages,SUM(FLOW_TOTAL) connectNumberOut from CONF_APPLICATION_GROUP g left join 	
											CONF_APPLICATION_GROUP_MAP m on g.id = m.app_group_id left join CONF_APPLICATION a
											on m.app_id = a.id left join ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime} f on a.id = f.app_id 
											<trim prefix="where" prefixOverrides="and |or ">
											<if test="terminal_name != null"> AND (f.src_ip = #{terminal_name}</if>
												<if test="terminal_name != null"> OR f.dst_ip = #{terminal_name})</if>
												  <if test="starttime != null"> AND f.ACQ_TIME <![CDATA[ > ]]>#{stime}</if>
												 <if test="endtime != null"> AND f.ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
										      </trim>
											group by g.id
											) t2 on t1.id = t2.id
										)
									)t3 
												
						
	</select>
	
	<select id="getappchartdatabyterminal" resultType="com.mainsteam.stm.portal.netflow.bo.TerminalBo" parameterType="com.mainsteam.stm.portal.netflow.bo.TerminalConditionBo">
							
			
							select acq_time, ifnull(in_flows,0) as in_flows,ifnull(in_packages,0) as in_packages,
							ifnull(out_flows,0) as out_flows,ifnull(out_packages,0) as out_packages, 
							ifnull(in_flows,0)+ifnull(out_flows,0) as total_flows,
							ifnull(in_packages,0)+ifnull(out_packages,0) as total_packages,
							ifnull(in_flows,0)/${timepart} as in_speed,
							ifnull(out_flows,0)/${timepart} as out_speed,
							ifnull(in_flows,0)/${timepart}+ifnull(out_flows,0)/${timepart} as total_speed,
							(ifnull(in_flows,0)+ifnull(out_flows,0))/${allapplicationflows} as flows_rate
							
							from 
								(
							
								select t1.acq_time,ifnull(in_flows,0) as in_flows,ifnull(in_packages,0) as in_packages,ifnull(out_flows,0) as out_flows,ifnull(out_packages,0) as out_packages from
								(
									(
										select f.acq_time,g.id,sum(octets_total) as in_flows,sum(packet_total) as in_packages from CONF_APPLICATION_GROUP g left join
										CONF_APPLICATION_GROUP_MAP m on g.id = m.app_group_id left join CONF_APPLICATION a
										on m.app_id = a.id left join ANA_IF_IN_NET_APP_TOS_${tableSubfixTime} f on a.id = f.app_id 
										where  g.id = #{currentapplication}
										and (f.src_ip = #{terminal_name} OR f.dst_ip = #{terminal_name})
										 and f.acq_time  in 
										 <foreach collection="timePoints" item="time" index="index"
					          			  open="(" close=")" separator=",">
					          			  #{time}
					       				 </foreach> 
										group by acq_time
									) t1 left join 
							
									(
									select f.acq_time,g.id,sum(octets_total) as out_flows,sum(packet_total) as out_packages from CONF_APPLICATION_GROUP g left join 
									CONF_APPLICATION_GROUP_MAP m on g.id = m.app_group_id left join CONF_APPLICATION a
									on m.app_id = a.id left join ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime} f on a.id = f.app_id 
									where  g.id = #{currentapplication}
									and (f.src_ip = #{terminal_name} OR f.dst_ip = #{terminal_name})
										 and f.acq_time  in 
										 <foreach collection="timePoints" item="time" index="index"
					          			  open="(" close=")" separator=",">
					          			  #{time}
					       			 </foreach> 
									group by acq_time
									) t2 on t1.acq_time = t2.acq_time
								)
								union
								select t2.acq_time,ifnull(in_flows,0) as in_flows,ifnull(in_packages,0) as in_packages,ifnull(out_flows,0) as out_flows,ifnull(out_packages,0) as out_packages from
								(
									(
										select f.acq_time,g.id,sum(octets_total) as in_flows,sum(packet_total) as in_packages from CONF_APPLICATION_GROUP g left join 
										CONF_APPLICATION_GROUP_MAP m on g.id = m.app_group_id left join CONF_APPLICATION a
										on m.app_id = a.id left join ANA_IF_IN_NET_APP_TOS_${tableSubfixTime} f on a.id = f.app_id 
										where  g.id = #{currentapplication}
										and (f.src_ip = #{terminal_name} OR f.dst_ip = #{terminal_name})
										 and f.acq_time  in 
										 <foreach collection="timePoints" item="time" index="index"
					          			  open="(" close=")" separator=",">
					          			  #{time}
					       			 </foreach> 
										group by acq_time
									) t1 right join 
							
									(
									select f.acq_time,g.id,sum(octets_total) as out_flows,sum(packet_total) as out_packages from CONF_APPLICATION_GROUP g left join 			
									CONF_APPLICATION_GROUP_MAP m on g.id = m.app_group_id left join CONF_APPLICATION a
									on m.app_id = a.id left join ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime} f on a.id = f.app_id 
									where  g.id = #{currentapplication}
									and (f.src_ip = #{terminal_name} OR f.dst_ip = #{terminal_name})
										 and f.acq_time  in 
										 <foreach collection="timePoints" item="time" index="index"
					          			  open="(" close=")" separator=",">
					          			  #{time}
					       			 </foreach> 
									group by acq_time
									) t2 on t1.acq_time = t2.acq_time
								)
							)t3 order by acq_time asc
	</select>
	
	<select id="getappnamebyidbyterminal" resultType="java.lang.String" parameterType="java.lang.String">
			select name from CONF_APPLICATION_GROUP where id = #{app_id}
	</select>
	
	
	
	
	<select id="getSessionsByTerminal" resultType="com.mainsteam.stm.portal.netflow.bo.TerminalBo" parameterType="com.mainsteam.stm.platform.mybatis.plugin.pagination.Page">
								select src_ip,dst_ip,out_flows,in_flows,total_flows,in_packages,out_packages, total_packages,in_speed,out_speed  ,total_speed,  flows_rate,
								flows_rate flowPctge,packets_rate packetPctge,connects_rate connectPctge,
								packetInSpeed,packetOutSpeed,packetTotalSpeed,
								connectNumberIn,connectNumberOut,connectNumberTotal,
								connectNumberInSpeed,connectNumberOutSpeed,connectNumberTotalSpeed
								from (
												select src_ip,dst_ip,in_flows,in_packages,out_flows,out_packages,total_flows,total_packages,
								in_speed,out_speed,total_speed,flows_rate,
								packets_rate,connects_rate,
								packetInSpeed,packetOutSpeed,packetTotalSpeed,
								connectNumberIn,connectNumberOut,connectNumberTotal,
								connectNumberInSpeed,connectNumberOutSpeed,connectNumberTotalSpeed
								from 
								(
									select intable.src_ip,intable.dst_ip,ifnull(in_packages,0) as in_packages,ifnull(in_flows,0) as in_flows,
									ifnull(out_packages,0) as out_packages,ifnull(out_flows,0) as out_flows,
									ifnull(in_flows,0)+ifnull(out_flows,0) as total_flows,ifnull(in_packages,0)+ifnull(out_packages,0) as total_packages,
									ifnull(in_flows,0)/${condition.timepart} as in_speed,ifnull(out_flows,0)/${condition.timepart} as out_speed, (ifnull(in_flows,0)/${condition.timepart})+(ifnull(out_flows,0)/${condition.timepart}) as total_speed,
									(ifnull(in_flows,0)+ifnull(out_flows,0))/${condition.allsessionFlows} as flows_rate,
									(ifnull(in_packages,0)+ifnull(out_packages,0))/${condition.wholePackets} as packets_rate,
									(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${condition.wholeConnects} as connects_rate,
									ifnull(in_packages,0)/${condition.timepart} packetInSpeed,ifnull(out_packages,0)/${condition.timepart} packetOutSpeed,(ifnull(in_packages,0)+ifnull(out_packages,0))/${condition.timepart} packetTotalSpeed,
									ifnull(connectNumberIn,0) connectNumberIn,ifnull(connectNumberOut,0) connectNumberOut,ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0) connectNumberTotal,
									ifnull(connectNumberIn,0)/${condition.timepart} connectNumberInSpeed,ifnull(connectNumberOut,0)/${condition.timepart} connectNumberOutSpeed,(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${condition.timepart} connectNumberTotalSpeed
									from 
										(
										select src_ip,dst_ip, sum(packet_total) as in_packages, sum(octets_total) as in_flows,
										SUM(FLOW_TOTAL) connectNumberIn 
										from ANA_IF_IN_NET_APP_TOS_${condition.tableSubfixTime}  
										where src_ip != '' and dst_ip!=''
						           		<if test="condition.app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${condition.app_id})
							           		 </if>
						           			<if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
											<if test="condition.if_id!= null"> and if_in_id=#{condition.if_id}</if>
											<if test="condition.terminal_name != null"> AND (src_ip = #{condition.terminal_name}</if>
											<if test="condition.terminal_name != null"> OR dst_ip = #{condition.terminal_name})</if>
										 <if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
										<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
										group by src_ip,dst_ip
										) intable left join 
										(
										select src_ip,dst_ip, sum(packet_total) as out_packages, sum(octets_total) as out_flows,
										SUM(FLOW_TOTAL) connectNumberOut 
										from ANA_IF_OUT_NET_APP_TOS_${condition.tableSubfixTime}  
										where src_ip != '' and dst_ip!=''
						           		<if test="condition.app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${condition.app_id})
							           		 </if>
						           		 <if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
										<if test="condition.if_id!= null"> and if_out_id=#{condition.if_id}</if>
										<if test="condition.terminal_name != null"> AND (src_ip = #{condition.terminal_name}</if>
										<if test="condition.terminal_name != null"> OR dst_ip = #{condition.terminal_name})</if>
										 <if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
										<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
										 group by src_ip,dst_ip
										) outtable 
									on intable.src_ip = outtable.src_ip and intable.dst_ip = outtable.dst_ip 
								)  _left
								union 
								select src_ip,dst_ip,in_flows,in_packages,out_flows,out_packages,total_flows,total_packages,
								in_speed,out_speed,total_speed,flows_rate,
								packets_rate,connects_rate,
								packetInSpeed,packetOutSpeed,packetTotalSpeed,
								connectNumberIn,connectNumberOut,connectNumberTotal,
								connectNumberInSpeed,connectNumberOutSpeed,connectNumberTotalSpeed
								from 
								(
									select outtable.src_ip,outtable.dst_ip,ifnull(in_packages,0) as in_packages,ifnull(in_flows,0) as in_flows,ifnull(out_packages,0) as out_packages,ifnull(out_flows,0) as out_flows,
									ifnull(in_flows,0)+ifnull(out_flows,0) as total_flows,ifnull(in_packages,0)+ifnull(out_packages,0) as total_packages,
									ifnull(in_flows,0)/${condition.timepart} as in_speed,ifnull(out_flows,0)/${condition.timepart} as out_speed, (ifnull(in_flows,0)/${condition.timepart})+(ifnull(out_flows,0)/${condition.timepart}) as total_speed,
									(ifnull(in_flows,0)+ifnull(out_flows,0))/${condition.allsessionFlows} as flows_rate,
									(ifnull(in_packages,0)+ifnull(out_packages,0))/${condition.wholePackets} as packets_rate,
									(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${condition.wholeConnects} as connects_rate,
									ifnull(in_packages,0)/${condition.timepart} packetInSpeed,ifnull(out_packages,0)/${condition.timepart} packetOutSpeed,(ifnull(in_packages,0)+ifnull(out_packages,0))/${condition.timepart} packetTotalSpeed,
									ifnull(connectNumberIn,0) connectNumberIn,ifnull(connectNumberOut,0) connectNumberOut,ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0) connectNumberTotal,
									ifnull(connectNumberIn,0)/${condition.timepart} connectNumberInSpeed,ifnull(connectNumberOut,0)/${condition.timepart} connectNumberOutSpeed,(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${condition.timepart} connectNumberTotalSpeed
									from 
										(
										select src_ip,dst_ip, sum(packet_total) as in_packages, sum(octets_total) as in_flows,
										SUM(FLOW_TOTAL) connectNumberIn
										from ANA_IF_IN_NET_APP_TOS_${condition.tableSubfixTime}  
										where src_ip != '' and dst_ip!=''
						           		<if test="condition.app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${condition.app_id})
							           		 </if>
						           			<if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
											<if test="condition.if_id!= null"> and if_in_id=#{condition.if_id}</if>
											<if test="condition.terminal_name != null"> AND  (src_ip = #{condition.terminal_name}</if>
										<if test="condition.terminal_name != null"> OR  dst_ip = #{condition.terminal_name})</if>
										 <if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
										<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
										group by src_ip,dst_ip
										) intable right join 
										(
										select src_ip,dst_ip, sum(packet_total) as out_packages, sum(octets_total) as out_flows,
										SUM(FLOW_TOTAL) connectNumberOut
										from ANA_IF_OUT_NET_APP_TOS_${condition.tableSubfixTime}
										where src_ip != '' and dst_ip!=''  
						           		 	<if test="condition.app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${condition.app_id})
							           		 </if>
						           		 	<if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
											<if test="condition.if_id!= null"> and if_out_id=#{condition.if_id}</if>
											<if test="condition.terminal_name != null"> AND  (src_ip = #{condition.terminal_name}</if>
										<if test="condition.terminal_name != null"> OR  dst_ip = #{condition.terminal_name})</if>
										 <if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
										<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
										 group by src_ip,dst_ip
										) outtable 
									on intable.src_ip = outtable.src_ip and intable.dst_ip = outtable.dst_ip 
								)  _right
							) flows order by  ${condition.sort}  ${condition.order}
	</select>
	
	<select id="getSessionsFlowsByTerminal" resultType="com.mainsteam.stm.portal.netflow.bo.Whole" parameterType="com.mainsteam.stm.portal.netflow.bo.TerminalConditionBo">
							
													select sum(total_flows) as wholeFlows,sum(total_packets) as wholePackets,sum(total_connects) as wholeConnects from (
															select src_ip,dst_ip,in_flows,out_flows,total_flows,
															total_packets,total_connects
														from 
														(
															select intable.src_ip,intable.dst_ip,ifnull(in_flows,0) as in_flows,
															ifnull(out_flows,0) as out_flows,
															ifnull(in_flows,0)+ifnull(out_flows,0) as total_flows,
															ifnull(packetIn,0)+ifnull(packetOut,0) as total_packets,
															ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0) as total_connects
															from 
																(
																select src_ip,dst_ip, sum(octets_total) as in_flows,
																SUM(packet_total) AS packetIn,
																SUM(FLOW_TOTAL) connectNumberIn
																from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime}  
																where src_ip != '' and dst_ip !=''
															
												           		 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
												           		 <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           	    	<if test="if_id != null"> AND if_in_id = #{if_id}</if>
											           	    	<if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
																<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
																 <if test="stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{stime}</if>
																<if test="etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
											 					
																group by src_ip,dst_ip
																) intable left join 
																(
																select src_ip,dst_ip ,sum(octets_total) as out_flows,
																SUM(packet_total) AS packetOut,
																SUM(FLOW_TOTAL) connectNumberOut
																from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}  
																where src_ip != '' and dst_ip!=''
												           		 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
												           		 <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           	    	<if test="if_id != null"> AND if_out_id = #{if_id}</if>
											           	    	<if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
																<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
																 <if test="stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{stime}</if>
																<if test="etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
																 group by src_ip,dst_ip
																) outtable 
															on intable.src_ip = outtable.src_ip and intable.dst_ip = outtable.dst_ip 
														)  _left
														union 
														select src_ip,dst_ip,in_flows,out_flows,total_flows,total_packets,total_connects
														 from 
														(
															select outtable.src_ip,outtable.dst_ip,ifnull(in_flows,0) as in_flows,ifnull(out_flows,0) as out_flows,
															ifnull(in_flows,0)+ifnull(out_flows,0) as total_flows,
															ifnull(packetIn,0)+ifnull(packetOut,0) as total_packets,
															ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0) as total_connects
															from 
																(
																select src_ip,dst_ip, sum(octets_total) as in_flows,
																SUM(packet_total) AS packetIn,
																SUM(FLOW_TOTAL) connectNumberIn
																from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime}  
																where src_ip != ' ' and dst_ip!=' '
												           		   <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
												           		  <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           	   		 <if test="if_id != null"> AND if_in_id = #{if_id}</if>
											           	   		 <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
																<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
																 <if test="stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{stime}</if>
																<if test="etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
																group by src_ip,dst_ip
																) intable right join 
																(
																select src_ip,dst_ip, sum(octets_total) as out_flows,
																SUM(packet_total) AS packetOut,
																SUM(FLOW_TOTAL) connectNumberOut
																from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}  
																where src_ip != '' and dst_ip!=''
												           		 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
												           		  <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           	   		 <if test="if_id != null"> AND if_out_id = #{if_id}</if>
											           	   		 <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
																<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
																 <if test="stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{stime}</if>
																<if test="etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
																 group by src_ip,dst_ip
																) outtable 
															on intable.src_ip = outtable.src_ip and intable.dst_ip = outtable.dst_ip 
														)  _right
									
													) flows
	</select>
	
	<select id="getSessionChartDataByTerminal" resultType="com.mainsteam.stm.portal.netflow.bo.TerminalBo" parameterType="com.mainsteam.stm.portal.netflow.bo.TerminalConditionBo">
						select acq_time, src_ip,dst_ip,in_flows,in_packages,out_flows,out_packages,total_flows,total_packages,
							in_speed,out_speed,total_speed,flows_rate,
							packetInSpeed,packetOutSpeed,packetTotalSpeed,
							connectNumberIn,connectNumberOut,connectNumberTotal,
							connectNumberInSpeed,connectNumberOutSpeed,connectNumberTotalSpeed
								from (
							select acq_time, src_ip,dst_ip,in_flows,in_packages,out_flows,out_packages,total_flows,total_packages,
							in_speed,out_speed,total_speed,flows_rate,
							packetInSpeed,packetOutSpeed,packetTotalSpeed,
							connectNumberIn,connectNumberOut,connectNumberTotal,
							connectNumberInSpeed,connectNumberOutSpeed,connectNumberTotalSpeed
							from 
							(
								select  intable.acq_time, intable.src_ip,intable.dst_ip,ifnull(in_packages,0) as in_packages,ifnull(in_flows,0) as in_flows,ifnull(out_packages,0) as out_packages,ifnull(out_flows,0) as out_flows,
								ifnull(in_flows,0)+ifnull(out_flows,0) as total_flows,ifnull(in_packages,0)+ifnull(out_packages,0) as total_packages,
								ifnull(in_flows,0)/${timepart} as in_speed,ifnull(out_flows,0)/${timepart} as out_speed, (ifnull(in_flows,0)/${timepart})+(ifnull(out_flows,0)/${timepart}) as total_speed,
								(ifnull(in_flows,0)+ifnull(out_flows,0))/${allsessionFlows} as flows_rate,
								ifnull(in_packages,0)/${timepart} as packetInSpeed,ifnull(out_packages,0)/${timepart} as packetOutSpeed,(ifnull(in_packages,0)+ifnull(out_packages,0))/${timepart} as packetTotalSpeed,
								ifnull(connectNumberIn,0) connectNumberIn,ifnull(connectNumberOut,0) connectNumberOut,ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0) connectNumberTotal,
								ifnull(connectNumberIn,0)/${timepart} as connectNumberInSpeed,ifnull(connectNumberOut,0)/${timepart} as connectNumberOutSpeed,(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${timepart} as connectNumberTotalSpeed
								from 
									(
									select acq_time,src_ip,dst_ip, sum(packet_total) as in_packages, sum(octets_total) as in_flows,
									SUM(FLOW_TOTAL) connectNumberIn 
									from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime}
									<trim prefix="where" prefixOverrides="and |or ">
									 <if test="currentSrcIp != null"> AND src_ip = #{currentSrcIp}</if>
									  <if test="currentDstIp != null"> AND dst_ip = #{currentDstIp}</if>
									   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
										  <if test="if_id != null"> AND if_in_id = #{if_id}</if>
										 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
												<if test="timePoints!=null">
													 and acq_time in 
												 <foreach collection="timePoints" item="time" index="index"
												 open="(" close=")" separator=",">
												 #{time}
												 </foreach> 
												</if>
									 </trim>   
									group by acq_time
									) intable left join 
									(
									select acq_time,src_ip,dst_ip, sum(packet_total) as out_packages, sum(octets_total) as out_flows,
									SUM(FLOW_TOTAL) connectNumberOut 
									from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}  
										<trim prefix="where" prefixOverrides="and |or ">
									 <if test="currentSrcIp != null"> AND src_ip = #{currentSrcIp}</if>
									  <if test="currentDstIp != null"> AND dst_ip = #{currentDstIp}</if>
									   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
										  <if test="if_id != null"> AND if_in_id = #{if_id}</if>
										 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
												<if test="timePoints!=null">
													 and acq_time in 
												 <foreach collection="timePoints" item="time" index="index"
												 open="(" close=")" separator=",">
												 #{time}
												 </foreach> 
												</if>
									 </trim>   
										group by acq_time
									) outtable 
								on intable.acq_time = outtable.acq_time 
							)  _left
							union 
							select acq_time, src_ip,dst_ip,in_flows,in_packages,out_flows,out_packages,total_flows,total_packages,
							in_speed,out_speed,total_speed,flows_rate,
							packetInSpeed,packetOutSpeed,packetTotalSpeed,
							connectNumberIn,connectNumberOut,connectNumberTotal,
							connectNumberInSpeed,connectNumberOutSpeed,connectNumberTotalSpeed
							from 
							(
								select outtable.acq_time, outtable.src_ip,outtable.dst_ip,ifnull(in_packages,0) as in_packages,ifnull(in_flows,0) as in_flows,ifnull(out_packages,0) as out_packages,ifnull(out_flows,0) as out_flows,
								ifnull(in_flows,0)+ifnull(out_flows,0) as total_flows,ifnull(in_packages,0)+ifnull(out_packages,0) as total_packages,
								ifnull(in_flows,0)/${timepart} as in_speed,ifnull(out_flows,0)/${timepart} as out_speed, (ifnull(in_flows,0)/${timepart})+(ifnull(out_flows,0)/${timepart}) as total_speed,
								(ifnull(in_flows,0)+ifnull(out_flows,0))/${allsessionFlows} as flows_rate,
								ifnull(in_packages,0)/${timepart} as packetInSpeed,ifnull(out_packages,0)/${timepart} as packetOutSpeed,(ifnull(in_packages,0)+ifnull(out_packages,0))/${timepart} as packetTotalSpeed,
								ifnull(connectNumberIn,0) connectNumberIn,ifnull(connectNumberOut,0) connectNumberOut,ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0) connectNumberTotal,
								ifnull(connectNumberIn,0)/${timepart} as connectNumberInSpeed,ifnull(connectNumberOut,0)/${timepart} as connectNumberOutSpeed,(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${timepart} as connectNumberTotalSpeed
								from 
									(
									select acq_time, src_ip,dst_ip, sum(packet_total) as in_packages, sum(octets_total) as in_flows,
									SUM(FLOW_TOTAL) connectNumberIn
									from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime}  
										<trim prefix="where" prefixOverrides="and |or ">
									 <if test="currentSrcIp != null"> AND src_ip = #{currentSrcIp}</if>
									  <if test="currentDstIp != null"> AND dst_ip = #{currentDstIp}</if>
									   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
										  <if test="if_id != null"> AND if_in_id = #{if_id}</if>
										 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
												<if test="timePoints!=null">
													 and acq_time in 
												 <foreach collection="timePoints" item="time" index="index"
												 open="(" close=")" separator=",">
												 #{time}
												 </foreach> 
												</if>
									 </trim>   
									group by acq_time
									) intable right join 
									(
									select acq_time, src_ip,dst_ip, sum(packet_total) as out_packages, sum(octets_total) as out_flows,
									SUM(FLOW_TOTAL) connectNumberOut
									from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}  
									<trim prefix="where" prefixOverrides="and |or ">
									 <if test="currentSrcIp != null"> AND src_ip = #{currentSrcIp}</if>
									  <if test="currentDstIp != null"> AND dst_ip = #{currentDstIp}</if>
									   <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
										  <if test="if_id != null"> AND if_in_id = #{if_id}</if>
										 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
												<if test="timePoints!=null">
													 and acq_time in 
												 <foreach collection="timePoints" item="time" index="index"
												 open="(" close=")" separator=",">
												 #{time}
												 </foreach> 
												</if>
									 </trim>   
								group by acq_time
									) outtable 
								on intable.acq_time = outtable.acq_time 
							)  _right
							) _time order by acq_time asc
							
						
	</select> 
	
	
	
	
	
	<select id="getProtocolByterminal" resultType="com.mainsteam.stm.portal.netflow.bo.TerminalBo" parameterType="com.mainsteam.stm.platform.mybatis.plugin.pagination.Page">
			
			select p.name as proto_name,p.id as proto, ifnull(f.in_flows,0) as in_flows,ifnull(f.in_packages,0) as in_packages,
				ifnull(f.out_flows,0) as out_flows,
				ifnull(f.out_packages,0) as out_packages,ifnull(f.total_flows,0) as total_flows,ifnull(total_packages,0) as total_packages,
				ifnull(f.in_speed,0) as in_speed,ifnull(f.out_speed,0) as out_speed,ifnull(f.total_speed,0) as total_speed,ifnull(f.flows_rate,0) as flows_rate,
				ifnull(flows_rate,0) flowPctge,ifnull(packets_rate,0) packetPctge,ifnull(connects_rate,0) connectPctge,
				ifnull(packetInSpeed,0) packetInSpeed,ifnull(packetOutSpeed,0) packetOutSpeed,ifnull(packetTotalSpeed,0) packetTotalSpeed,
				ifnull(connectNumberIn,0) connectNumberIn,ifnull(connectNumberOut,0) connectNumberOut,ifnull(connectNumberTotal,0) connectNumberTotal,
				ifnull(connectNumberInSpeed,0) connectNumberInSpeed,ifnull(connectNumberOutSpeed,0) connectNumberOutSpeed,ifnull(connectNumberTotalSpeed,0) connectNumberTotalSpeed
				from CONF_PROTOCOL p left join
			
							(select proto,in_flows,in_packages,out_flows,out_packages,total_flows,total_packages,
							in_speed,out_speed,total_speed,flows_rate,packets_rate,connects_rate,
							packetInSpeed,packetOutSpeed,packetTotalSpeed,
							connectNumberIn,connectNumberOut,connectNumberTotal,
							connectNumberInSpeed,connectNumberOutSpeed,connectNumberTotalSpeed
							from (
								select proto,ifnull(in_flows,0) as in_flows,ifnull(in_packages,0) as in_packages,
								ifnull(out_flows,0) as out_flows,ifnull(out_packages,0) as out_packages,
								(ifnull(in_flows,0)+ifnull(out_flows,0)) as total_flows,
								(ifnull(in_packages,0)+ifnull(out_packages,0)) as total_packages,
								ifnull(in_flows,0)/${condition.timepart} as in_speed,
								ifnull(out_flows,0)/${condition.timepart} as out_speed,
								(ifnull(in_flows,0)+ifnull(out_flows,0))/${condition.timepart} as total_speed,
								(ifnull(in_flows,0)+ifnull(out_flows,0))/${condition.allprotoflows} as flows_rate,
								(ifnull(in_packages,0)+ifnull(out_packages,0))/${condition.wholePackets} as packets_rate,
								(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${condition.wholeConnects} as connects_rate,
								ifnull(in_packages,0)/${condition.timepart} packetInSpeed,ifnull(out_packages,0)/${condition.timepart} packetOutSpeed,(ifnull(in_packages,0)+ifnull(out_packages,0))/${condition.timepart} packetTotalSpeed,
								ifnull(connectNumberIn,0) connectNumberIn,ifnull(connectNumberOut,0) connectNumberOut,ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0) connectNumberTotal,
								ifnull(connectNumberIn,0)/${condition.timepart} connectNumberInSpeed,ifnull(connectNumberOut,0)/${condition.timepart} connectNumberOutSpeed,(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${condition.timepart} connectNumberTotalSpeed
								from (
									select t1.proto as proto,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
									from (
										(select proto, sum(octets_total) as in_flows,sum(packet_total) as in_packages,
										SUM(FLOW_TOTAL) connectNumberIn
										from ANA_IF_IN_NET_APP_TOS_${condition.tableSubfixTime}  
										<trim prefix="where" prefixOverrides="and |or ">
											<if test="condition.app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${condition.app_id})
							           		 </if>
											<if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
											<if test="condition.if_id!= null"> and if_in_id=#{condition.if_id}</if>
												<if test="condition.terminal_name != null"> AND  (src_ip = #{condition.terminal_name}</if>
										<if test="condition.terminal_name != null"> OR  dst_ip = #{condition.terminal_name})</if>
											<if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
										 </trim>
										group by proto) t1 
										left join
										(select proto, sum(octets_total) as out_flows,sum(packet_total) as out_packages,
										SUM(FLOW_TOTAL) connectNumberOut
										from ANA_IF_OUT_NET_APP_TOS_${condition.tableSubfixTime} 
										<trim prefix="where" prefixOverrides="and |or ">
											<if test="condition.app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${condition.app_id})
							           		 </if>
											<if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
											<if test="condition.if_id!= null"> and if_out_id=#{condition.if_id}</if>
												<if test="condition.terminal_name != null"> AND  (src_ip = #{condition.terminal_name}</if>
											<if test="condition.terminal_name != null"> OR  dst_ip = #{condition.terminal_name})</if>
											<if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
										 </trim>
										group by proto) t2 
										on t1.proto = t2.proto
									) 
									union
									select t2.proto,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
									from (
										(select proto, sum(octets_total) as in_flows,sum(packet_total) as in_packages,
										SUM(FLOW_TOTAL) connectNumberIn
										from ANA_IF_IN_NET_APP_TOS_${condition.tableSubfixTime}  
										<trim prefix="where" prefixOverrides="and |or ">
											<if test="condition.app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${condition.app_id})
							           		 </if>
											<if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
											<if test="condition.if_id!= null"> and if_in_id=#{condition.if_id}</if>
												<if test="condition.terminal_name != null"> AND  (src_ip = #{condition.terminal_name}</if>
											<if test="condition.terminal_name != null"> OR  dst_ip = #{condition.terminal_name})</if>
											<if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
										 </trim>
										group by proto) t1 
										right join
										(select proto, sum(octets_total) as out_flows,sum(packet_total) as out_packages,
										SUM(FLOW_TOTAL) connectNumberOut
										from ANA_IF_OUT_NET_APP_TOS_${condition.tableSubfixTime}
										<trim prefix="where" prefixOverrides="and |or ">
										<if test="condition.app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${condition.app_id})
							           		 </if>
											<if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
											<if test="condition.if_id!= null"> and if_out_id=#{condition.if_id}</if>
											<if test="condition.terminal_name != null"> AND  (src_ip = #{condition.terminal_name}</if>
											<if test="condition.terminal_name != null"> OR  dst_ip = #{condition.terminal_name})</if>
											<if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
										 </trim>
										group by proto) t2 
										on t1.proto = t2.proto
									) 
								) t4
							) t5
							) f  on p.id = f.proto  order by ${condition.sort}  ${condition.order}
	</select>
	
	<select id="getAllProtocolFlowsByterminal" resultType="com.mainsteam.stm.portal.netflow.bo.Whole" parameterType="com.mainsteam.stm.portal.netflow.bo.TerminalConditionBo">
										select sum(total_flows) wholeFlows,sum(total_packages) wholePackets,sum(connectNumberTotal) wholeConnects from (
											select proto,in_flows,in_packages,out_flows,out_packages,total_flows,total_packages,
											in_speed,out_speed,connectNumberTotal from (
												select proto,ifnull(in_flows,0) as in_flows,ifnull(in_packages,0) as in_packages,
												ifnull(out_flows,0) as out_flows,ifnull(out_packages,0) as out_packages,
												(ifnull(in_flows,0)+ifnull(out_flows,0)) as total_flows,
												(ifnull(in_packages,0)+ifnull(out_packages,0)) as total_packages,
												ifnull(in_flows,0)/${timepart} as in_speed,
												ifnull(out_flows,0)/${timepart} as out_speed,
												(ifnull(in_flows,0)+ifnull(out_flows,0))/${timepart} as total_speed,
												ifnull(connectNumberIn,0) connectNumberIn,ifnull(connectNumberOut,0) connectNumberOut,ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0) connectNumberTotal
												from (
													select t1.proto as proto,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
													from (
														(select proto, sum(octets_total) as in_flows,sum(packet_total) as in_packages,
														SUM(FLOW_TOTAL) connectNumberIn
														from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime}
														<trim prefix="where" prefixOverrides="and |or ">
															 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
															<if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           		 <if test="if_id != null"> AND if_in_id = #{if_id}</if>
											           		  <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
																<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
															<if test="stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{stime}</if>
															<if test="etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
														 </trim>
														group by proto) t1 
														left join
														(select proto, sum(octets_total) as out_flows,sum(packet_total) as out_packages,
														SUM(FLOW_TOTAL) connectNumberOut
														from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}
														<trim prefix="where" prefixOverrides="and |or ">
															 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
															<if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           		   <if test="if_id != null"> AND if_out_id = #{if_id}</if>
											           		    <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
																<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
															<if test="stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{stime}</if>
															<if test="etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
														 </trim>
														group by proto) t2 
														on t1.proto = t2.proto
													) 
													union
													select t2.proto,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
													from (
														(select proto, sum(octets_total) as in_flows,sum(packet_total) as in_packages,
														SUM(FLOW_TOTAL) connectNumberIn
														from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime} 
														<trim prefix="where" prefixOverrides="and |or ">
															 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
															<if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           		   <if test="if_id != null"> AND if_in_id = #{if_id}</if>
											           		    <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
																<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
															<if test="stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{stime}</if>
															<if test="etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
														 </trim>
														group by proto) t1 
														right join
														(select proto, sum(octets_total) as out_flows,sum(packet_total) as out_packages,
														SUM(FLOW_TOTAL) connectNumberOut
														from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}
														<trim prefix="where" prefixOverrides="and |or ">
															<if test="app_id != null"> app_id=${app_id}</if>
															<if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           	    <if test="if_id != null"> AND if_out_id = #{if_id}</if>
											           	     <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
															<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
															<if test="stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{stime}</if>
															<if test="etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
														 </trim>
														group by proto) t2 
														on t1.proto = t2.proto
													) 
												) t4
											) t5 
										) t6
	</select>
	<select id="getProtocolChartDataByterminal" resultType="com.mainsteam.stm.portal.netflow.bo.TerminalBo" parameterType="com.mainsteam.stm.portal.netflow.bo.TerminalConditionBo">
			select acq_time,in_flows,in_packages,out_flows,out_packages,total_flows,total_packages,
				in_speed,out_speed,total_speed,flows_rate,
				packetInSpeed,packetOutSpeed,packetTotalSpeed,
				connectNumberIn,connectNumberOut,connectNumberTotal,
				connectNumberInSpeed,connectNumberOutSpeed,connectNumberTotalSpeed
				from (
					select acq_time,ifnull(in_flows,0) as in_flows,ifnull(in_packages,0) as in_packages,
					ifnull(out_flows,0) as out_flows,ifnull(out_packages,0) as out_packages,
					(ifnull(in_flows,0)+ifnull(out_flows,0)) as total_flows,
					(ifnull(in_packages,0)+ifnull(out_packages,0)) as total_packages,
					ifnull(in_flows,0)/${timepart} as in_speed,
					ifnull(out_flows,0)/${timepart} as out_speed,
					(ifnull(in_flows,0)+ifnull(out_flows,0))/${timepart} as total_speed,
					(ifnull(in_flows,0)+ifnull(out_flows,0))/${allprotoflows} as flows_rate,
					ifnull(in_packages,0)/${timepart} as packetInSpeed,ifnull(out_packages,0)/${timepart} as packetOutSpeed,(ifnull(in_packages,0)+ifnull(out_packages,0))/${timepart} as packetTotalSpeed,
					ifnull(connectNumberIn,0) connectNumberIn,ifnull(connectNumberOut,0) connectNumberOut,ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0) connectNumberTotal,
					ifnull(connectNumberIn,0)/${timepart} as connectNumberInSpeed,ifnull(connectNumberOut,0)/${timepart} as connectNumberOutSpeed,(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${timepart} as connectNumberTotalSpeed
					from (
						select t1.acq_time as acq_time,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
						from (
							(select acq_time, sum(octets_total) as in_flows,sum(packet_total) as in_packages,
							SUM(FLOW_TOTAL) connectNumberIn
							from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime} 
							<trim prefix="where" prefixOverrides="and |or ">
									 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
									 <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
									 <if test="if_id != null"> AND if_in_id = #{if_id}</if>
									 <if test="currentproto != null"> AND proto = ${currentproto}</if>
									   <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
										<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
										<if test="timePoints !=null">
											 and acq_time  in 
											 <foreach collection="timePoints" item="time" index="index"
						          			  open="(" close=")" separator=",">
						          			  #{time}
						       				 </foreach> 
										</if>
							 </trim>
							group by acq_time) t1 
							left join
							(select acq_time, sum(octets_total) as out_flows,sum(packet_total) as out_packages,
							SUM(FLOW_TOTAL) connectNumberOut
							from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}
								<trim prefix="where" prefixOverrides="and |or ">
								 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
									 <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
									 <if test="if_id != null"> AND if_out_id = #{if_id}</if>
									 <if test="currentproto != null"> AND proto = ${currentproto}</if>
									 <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
										<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
										<if test="timePoints !=null">
											 and acq_time  in 
											 <foreach collection="timePoints" item="time" index="index"
						          			  open="(" close=")" separator=",">
						          			  #{time}
						       				 </foreach> 
										</if>
							 </trim>
							group by acq_time) t2 
							on t1.acq_time= t2.acq_time
						) 
						union
						select t2.acq_time,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
						from (
							(select acq_time, sum(octets_total) as in_flows,sum(packet_total) as in_packages,
							SUM(FLOW_TOTAL) connectNumberIn
							from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime}
								<trim prefix="where" prefixOverrides="and |or ">
									 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
									 <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
									 <if test="if_id != null"> AND if_in_id = #{if_id}</if>
									 <if test="currentproto != null"> AND proto = ${currentproto}</if>
									 <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
										<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
										<if test="timePoints !=null">
											 and acq_time  in 
											 <foreach collection="timePoints" item="time" index="index"
						          			  open="(" close=")" separator=",">
						          			  #{time}
						       				 </foreach> 
										</if>
							 </trim>
							group by acq_time) t1 
							right join
							(select acq_time, sum(octets_total) as out_flows,sum(packet_total) as out_packages,
							SUM(FLOW_TOTAL) connectNumberOut
							from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}
								<trim prefix="where" prefixOverrides="and |or ">
									 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
									 <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
									 <if test="if_id != null"> AND if_out_id = #{if_id}</if>
									 <if test="currentproto != null"> AND proto = ${currentproto}</if>
									 <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
										<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
										<if test="timePoints !=null">
											 and acq_time  in 
											 <foreach collection="timePoints" item="time" index="index"
						          			  open="(" close=")" separator=",">
						          			  #{time}
						       				 </foreach> 
										</if>
							 </trim>
		       				 
							group by acq_time) t2 
							on t1.acq_time = t2.acq_time
						) 
					) t4
				) t5 order by acq_time asc
	</select>
	
	<select id="getprotonamebyidbyapp" resultType="java.lang.String" parameterType="java.lang.String">
			select name from CONF_PROTOCOL where id = #{proto}
	</select>
	
	
	
	
	<select id="getTosByterminal" resultType="com.mainsteam.stm.portal.netflow.bo.TerminalBo" parameterType="com.mainsteam.stm.platform.mybatis.plugin.pagination.Page">
			
			select p.name as tos_name,p.id as tos, ifnull(f.in_flows,0) as in_flows,ifnull(f.in_packages,0) as in_packages,
				ifnull(f.out_flows,0) as out_flows,
				ifnull(f.out_packages,0) as out_packages,ifnull(f.total_flows,0) as total_flows,ifnull(total_packages,0) as total_packages,
				ifnull(f.in_speed,0) as in_speed,ifnull(f.out_speed,0) as out_speed,ifnull(f.total_speed,0) as total_speed,ifnull(f.flows_rate,0) as flows_rate,
				ifnull(f.flows_rate,0) as flowPctge,ifnull(f.packets_rate,0) as packetPctge,ifnull(f.connects_rate,0) as connectPctge,
				ifnull(f.packetInSpeed,0) as packetInSpeed,ifnull(f.packetOutSpeed,0) as packetOutSpeed,ifnull(f.packetTotalSpeed,0) as packetTotalSpeed,
				ifnull(f.connectNumberIn,0) as connectNumberIn,ifnull(f.connectNumberOut,0) as connectNumberOut,ifnull(f.connectNumberTotal,0) as connectNumberTotal,
				ifnull(f.connectNumberInSpeed,0) as connectNumberInSpeed,ifnull(f.connectNumberOutSpeed,0) as connectNumberOutSpeed,ifnull(f.connectNumberTotalSpeed,0) as connectNumberTotalSpeed
				from CONF_TOS p left join
			
							(select tos,in_flows,in_packages,out_flows,out_packages,total_flows,total_packages,
							in_speed,out_speed,total_speed,flows_rate,
							packets_rate,connects_rate,
							packetInSpeed,packetOutSpeed,packetTotalSpeed,
							connectNumberIn,connectNumberOut,connectNumberTotal,
							connectNumberInSpeed,connectNumberOutSpeed,connectNumberTotalSpeed
							from (
								select tos,ifnull(in_flows,0) as in_flows,ifnull(in_packages,0) as in_packages,
								ifnull(out_flows,0) as out_flows,ifnull(out_packages,0) as out_packages,
								(ifnull(in_flows,0)+ifnull(out_flows,0)) as total_flows,
								(ifnull(in_packages,0)+ifnull(out_packages,0)) as total_packages,
								ifnull(in_flows,0)/${condition.timepart} as in_speed,
								ifnull(out_flows,0)/${condition.timepart} as out_speed,
								(ifnull(in_flows,0)+ifnull(out_flows,0))/${condition.timepart} as total_speed,
								(ifnull(in_flows,0)+ifnull(out_flows,0))/${condition.allprotoflows} as flows_rate,
								(ifnull(in_packages,0)+ifnull(out_packages,0))/${condition.wholePackets} as packets_rate,
								(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${condition.wholeConnects} as connects_rate,
								ifnull(in_packages,0)/${condition.timepart} packetInSpeed,ifnull(out_packages,0)/${condition.timepart} packetOutSpeed,ifnull(ifnull(in_packages,0)+ifnull(out_packages,0),0)/${condition.timepart} packetTotalSpeed,
								ifnull(connectNumberIn,0) connectNumberIn,ifnull(connectNumberOut,0) connectNumberOut,ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0) connectNumberTotal,
								ifnull(connectNumberIn,0)/${condition.timepart} connectNumberInSpeed,ifnull(connectNumberOut,0)/${condition.timepart} connectNumberOutSpeed,(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${condition.timepart} connectNumberTotalSpeed
								from (
									select t1.tos as tos,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
									from (
										(select tos, sum(octets_total) as in_flows,sum(packet_total) as in_packages,
										SUM(FLOW_TOTAL) connectNumberIn
										from ANA_IF_IN_NET_APP_TOS_${condition.tableSubfixTime}  
										<trim prefix="where" prefixOverrides="and |or ">
											<if test="condition.app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${condition.app_id})
							           		 </if>
											<if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
											<if test="condition.if_id!= null"> and if_in_id=#{condition.if_id}</if>
												<if test="condition.terminal_name != null"> AND  (src_ip = #{condition.terminal_name}</if>
										<if test="condition.terminal_name != null"> OR  dst_ip = #{condition.terminal_name})</if>
											<if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
										 </trim>
										group by tos) t1 
										left join
										(select tos, sum(octets_total) as out_flows,sum(packet_total) as out_packages,
										SUM(FLOW_TOTAL) connectNumberOut
										from ANA_IF_OUT_NET_APP_TOS_${condition.tableSubfixTime} 
										<trim prefix="where" prefixOverrides="and |or ">
											<if test="condition.app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${condition.app_id})
							           		 </if>
											<if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
											<if test="condition.if_id!= null"> and if_out_id=#{condition.if_id}</if>
												<if test="condition.terminal_name != null"> AND  (src_ip = #{condition.terminal_name}</if>
											<if test="condition.terminal_name != null"> OR  dst_ip = #{condition.terminal_name})</if>
											<if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
										 </trim>
										group by tos) t2 
										on t1.tos = t2.tos
									) 
									union
									select t2.tos,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
									from (
										(select tos, sum(octets_total) as in_flows,sum(packet_total) as in_packages,
										SUM(FLOW_TOTAL) connectNumberIn
										from ANA_IF_IN_NET_APP_TOS_${condition.tableSubfixTime}  
										<trim prefix="where" prefixOverrides="and |or ">
											<if test="condition.app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${condition.app_id})
							           		 </if>
											<if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
											<if test="condition.if_id!= null"> and if_in_id=#{condition.if_id}</if>
												<if test="condition.terminal_name != null"> AND  (src_ip = #{condition.terminal_name}</if>
											<if test="condition.terminal_name != null"> OR  dst_ip = #{condition.terminal_name})</if>
											<if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
										 </trim>
										group by tos) t1 
										right join
										(select tos, sum(octets_total) as out_flows,sum(packet_total) as out_packages,
										SUM(FLOW_TOTAL) connectNumberOut
										from ANA_IF_OUT_NET_APP_TOS_${condition.tableSubfixTime}
										<trim prefix="where" prefixOverrides="and |or ">
										<if test="condition.app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${condition.app_id})
							           		 </if>
											<if test="condition.deviceIp != null"> AND router_ip = inet_aton(#{condition.deviceIp})</if>
											<if test="condition.if_id!= null"> and if_out_id=#{condition.if_id}</if>
											<if test="condition.terminal_name != null"> AND  (src_ip = #{condition.terminal_name}</if>
											<if test="condition.terminal_name != null"> OR  dst_ip = #{condition.terminal_name})</if>
											<if test="condition.stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{condition.stime}</if>
											<if test="condition.etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{condition.etime}</if>
										 </trim>
										group by tos) t2 
										on t1.tos = t2.tos
									) 
								) t4
							) t5
							) f  on p.id = f.tos  order by ${condition.sort}  ${condition.order}
	</select>
	
	
	<select id="getAllTosFlowsByterminal" resultType="com.mainsteam.stm.portal.netflow.bo.Whole" parameterType="com.mainsteam.stm.portal.netflow.bo.TerminalConditionBo">
										select sum(total_flows) wholeFlows,sum(total_packages) wholePackets,sum(total_connects) wholeConnects from (
											select tos,in_flows,in_packages,out_flows,out_packages,total_flows,total_packages,
											in_speed,out_speed,total_connects from (
												select tos,ifnull(in_flows,0) as in_flows,ifnull(in_packages,0) as in_packages,
												ifnull(out_flows,0) as out_flows,ifnull(out_packages,0) as out_packages,
												(ifnull(in_flows,0)+ifnull(out_flows,0)) as total_flows,
												(ifnull(in_packages,0)+ifnull(out_packages,0)) as total_packages,
												ifnull(in_flows,0)/${timepart} as in_speed,
												ifnull(out_flows,0)/${timepart} as out_speed,
												(ifnull(in_flows,0)+ifnull(out_flows,0))/${timepart} as total_speed,
												(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0)) as total_connects
												from (
													select t1.tos as tos,in_flows,in_packages,out_flows,out_packages,
													connectNumberIn,connectNumberOut
													from (
														(select tos, sum(octets_total) as in_flows,sum(packet_total) as in_packages,
														SUM(FLOW_TOTAL) connectNumberIn
														from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime}
														<trim prefix="where" prefixOverrides="and |or ">
															 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
															<if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           		 <if test="if_id != null"> AND if_in_id = #{if_id}</if>
											           		  <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
																<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
															<if test="stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{stime}</if>
															<if test="etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
														 </trim>
														group by tos) t1 
														left join
														(select tos, sum(octets_total) as out_flows,sum(packet_total) as out_packages,
														SUM(FLOW_TOTAL) connectNumberOut
														from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}
														<trim prefix="where" prefixOverrides="and |or ">
															 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
															<if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           		   <if test="if_id != null"> AND if_out_id = #{if_id}</if>
											           		    <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
																<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
															<if test="stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{stime}</if>
															<if test="etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
														 </trim>
														group by tos) t2 
														on t1.tos = t2.tos
													) 
													union
													select t2.tos,in_flows,in_packages,out_flows,out_packages,
													connectNumberIn,connectNumberOut
													from (
														(select tos, sum(octets_total) as in_flows,sum(packet_total) as in_packages,
														SUM(FLOW_TOTAL) connectNumberIn
														from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime} 
														<trim prefix="where" prefixOverrides="and |or ">
															 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
															<if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           		   <if test="if_id != null"> AND if_in_id = #{if_id}</if>
											           		    <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
																<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
															<if test="stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{stime}</if>
															<if test="etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
														 </trim>
														group by tos) t1 
														right join
														(select tos, sum(octets_total) as out_flows,sum(packet_total) as out_packages,
														SUM(FLOW_TOTAL) connectNumberOut
														from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}
														<trim prefix="where" prefixOverrides="and |or ">
															<if test="app_id != null"> app_id=${app_id}</if>
															<if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
											           	    <if test="if_id != null"> AND if_out_id = #{if_id}</if>
											           	     <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
															<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
															<if test="stime != null"> AND ACQ_TIME <![CDATA[ > ]]> #{stime}</if>
															<if test="etime != null"> AND ACQ_TIME <![CDATA[ <= ]]> #{etime}</if>
														 </trim>
														group by tos) t2 
														on t1.tos = t2.tos
													) 
												) t4
											) t5 
										) t6
	</select>
	
	<select id="getTosChartDataByterminal" resultType="com.mainsteam.stm.portal.netflow.bo.TerminalBo" parameterType="com.mainsteam.stm.portal.netflow.bo.TerminalConditionBo">
			select acq_time,in_flows,in_packages,out_flows,out_packages,total_flows,total_packages,
				in_speed,out_speed,total_speed,flows_rate,
				packetInSpeed,packetOutSpeed,packetTotalSpeed,
				connectNumberIn,connectNumberOut,connectNumberTotal,
				connectNumberInSpeed,connectNumberOutSpeed,connectNumberTotalSpeed
				from (
					select acq_time,ifnull(in_flows,0) as in_flows,ifnull(in_packages,0) as in_packages,
					ifnull(out_flows,0) as out_flows,ifnull(out_packages,0) as out_packages,
					(ifnull(in_flows,0)+ifnull(out_flows,0)) as total_flows,
					(ifnull(in_packages,0)+ifnull(out_packages,0)) as total_packages,
					ifnull(in_flows,0)/${timepart} as in_speed,
					ifnull(out_flows,0)/${timepart} as out_speed,
					(ifnull(in_flows,0)+ifnull(out_flows,0))/${timepart} as total_speed,
					(ifnull(in_flows,0)+ifnull(out_flows,0))/${allprotoflows} as flows_rate,
					ifnull(in_packages,0)/${timepart} packetInSpeed,ifnull(out_packages,0)/${timepart} packetOutSpeed,(ifnull(in_packages,0)+ifnull(out_packages,0))/${timepart} packetTotalSpeed,
					ifnull(connectNumberIn,0) connectNumberIn,ifnull(connectNumberOut,0) connectNumberOut,ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0) connectNumberTotal,
					ifnull(connectNumberIn,0)/${timepart} connectNumberInSpeed,ifnull(connectNumberOut,0)/${timepart} connectNumberOutSpeed,(ifnull(connectNumberIn,0)+ifnull(connectNumberOut,0))/${timepart} connectNumberTotalSpeed
					from (
						select t1.acq_time as acq_time,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
						from (
							(select acq_time, sum(octets_total) as in_flows,sum(packet_total) as in_packages,
							SUM(FLOW_TOTAL) connectNumberIn
							from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime} 
							<trim prefix="where" prefixOverrides="and |or ">
									 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
									 <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
									 <if test="if_id != null"> AND if_in_id = #{if_id}</if>
									 <if test="currentproto != null"> AND tos = ${currentproto}</if>
									   <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
										<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
										<if test="timePoints !=null">
											 and acq_time  in 
											 <foreach collection="timePoints" item="time" index="index"
						          			  open="(" close=")" separator=",">
						          			  #{time}
						       				 </foreach> 
										</if>
							 </trim>
							group by acq_time) t1 
							left join
							(select acq_time, sum(octets_total) as out_flows,sum(packet_total) as out_packages,
							SUM(FLOW_TOTAL) connectNumberOut
							from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}
								<trim prefix="where" prefixOverrides="and |or ">
								 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
									 <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
									 <if test="if_id != null"> AND if_out_id = #{if_id}</if>
									 <if test="currentproto != null"> AND tos = ${currentproto}</if>
									 <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
										<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
										<if test="timePoints !=null">
											 and acq_time  in 
											 <foreach collection="timePoints" item="time" index="index"
						          			  open="(" close=")" separator=",">
						          			  #{time}
						       				 </foreach> 
										</if>
							 </trim>
							group by acq_time) t2 
							on t1.acq_time= t2.acq_time
						) 
						union
						select t2.acq_time,in_flows,in_packages,out_flows,out_packages,connectNumberIn,connectNumberOut
						from (
							(select acq_time, sum(octets_total) as in_flows,sum(packet_total) as in_packages,
							SUM(FLOW_TOTAL) connectNumberIn
							from ANA_IF_IN_NET_APP_TOS_${tableSubfixTime}
								<trim prefix="where" prefixOverrides="and |or ">
									 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
									 <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
									 <if test="if_id != null"> AND if_in_id = #{if_id}</if>
									 <if test="currentproto != null"> AND tos = ${currentproto}</if>
									 <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
										<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
										<if test="timePoints !=null">
											 and acq_time  in 
											 <foreach collection="timePoints" item="time" index="index"
						          			  open="(" close=")" separator=",">
						          			  #{time}
						       				 </foreach> 
										</if>
							 </trim>
							group by acq_time) t1 
							right join
							(select acq_time, sum(octets_total) as out_flows,sum(packet_total) as out_packages,
							SUM(FLOW_TOTAL) connectNumberOut
							from ANA_IF_OUT_NET_APP_TOS_${tableSubfixTime}
								<trim prefix="where" prefixOverrides="and |or ">
									 <if test="app_id != null"> AND app_id in 
							           		 (select m.app_id from CONF_APPLICATION_GROUP g left join CONF_APPLICATION_GROUP_MAP m  on g.id = m.APP_GROUP_ID where g.id = ${app_id})
							           		 </if>
									 <if test="deviceIp != null"> AND router_ip = inet_aton(#{deviceIp})</if>
									 <if test="if_id != null"> AND if_out_id = #{if_id}</if>
									 <if test="currentproto != null"> AND tos = ${currentproto}</if>
									 <if test="terminal_name != null"> AND  (src_ip = #{terminal_name}</if>
										<if test="terminal_name != null"> OR  dst_ip = #{terminal_name})</if>
										<if test="timePoints !=null">
											 and acq_time  in 
											 <foreach collection="timePoints" item="time" index="index"
						          			  open="(" close=")" separator=",">
						          			  #{time}
						       				 </foreach> 
										</if>
							 </trim>
		       				 
							group by acq_time) t2 
							on t1.acq_time = t2.acq_time
						) 
					) t4
				) t5 order by acq_time asc
	</select>
	
		<select id="gettosnamebyidbyterminal" resultType="java.lang.String" parameterType="java.lang.String">
			select name from CONF_TOS where id = #{tos}
	</select>
</mapper>
