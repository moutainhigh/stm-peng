function ChoserBox(args){this.paper=args.paper;this.$svg=$(args.holder);this.util=new Util(args);this.firstPoint=null;this.secondPoint={x:0,y:0};this.editable=true;this.init();this.util=new Util(args);this.regEvent();};ChoserBox.prototype={remove:function(){this.areaPath=null;this.border.remove();this.border=null;clearInterval(this.timeId);this.timeId=null;delete this.firstPoint;this.firstPoint=null;delete this.secondPoint;this.secondPoint=null;},toFront:function(){this.border.toFront();},getValue:function(){if(this.firstPoint&&this.secondPoint){var r={x1:this.firstPoint.x||0,y1:this.firstPoint.y||0,x2:this.secondPoint.x||0,y2:this.secondPoint.y||0};if(r.x1>r.x2){r.x1=this.secondPoint.x;r.x2=this.firstPoint.x;};if(r.y1>r.y2){r.y1=this.secondPoint.y;r.y2=this.firstPoint.y;};r.cx=(r.x1+r.x2)/2;r.cy=(r.y1+r.y2)/2;r.w=Math.abs(r.x2-r.x1);r.h=Math.abs(r.y2-r.y1);return r;};return null;},hide:function(){this.border.hide();},show:function(){this.border.show();},setEditable:function(flag){this.editable=!!flag;if(!this.editable){this.hide();}else{this.refresh();this.show();}},regEvent:function(){var ctx=this;this.timeId=setInterval(function(){ctx.border.attr({"stroke-dasharray":ctx.border.flag?"--":"- "});ctx.border.flag=!!!ctx.border.flag;},100);this.$svg.on("mousedown",function(e){if(ctx.editable){var vb=ctx.util.getEventPosition(e);$(this).css("cursor","crosshair");if(!ctx.firstPoint){ctx.firstPoint={x:vb.x,y:vb.y};}else{ctx.onFinished(ctx.getValue());delete ctx.firstPoint;ctx.firstPoint=null;};ctx.toFront();ctx.show();};return false;});this.$svg.on("mouseup",function(e){if(ctx.editable){$(this).css("cursor","default");ctx.onFinished(ctx.getValue());delete ctx.firstPoint;ctx.firstPoint=null;ctx.hide();}});this.$svg.on("mousemove",function(e){if(ctx.editable){var vb=ctx.util.getEventPosition(e);if(!ctx.secondPoint){ctx.secondPoint={};};ctx.secondPoint.x=vb.x;ctx.secondPoint.y=vb.y;ctx.refresh();}});},onFinished:function(){},onRefresh:function(){},refresh:function(){if(this.firstPoint){this.areaPath=this.util.getRoundRectPath({x:this.firstPoint.x,y:this.firstPoint.y,r:0,w:this.secondPoint.x-this.firstPoint.x,h:this.secondPoint.y-this.firstPoint.y});this.border.attr("path",this.areaPath);}else{this.border.attr("path",this.util.getRoundRectPath({x:0,y:0,r:0,w:0,h:0}));};this.onRefresh();},init:function(){this.areaPath=this.util.getRoundRectPath({x:0,y:0,r:0,w:0,h:0});this.border=this.paper.path(this.areaPath).attr({"stroke":"black","fill":"white","opacity":0.5});}};function Util(args){this.paper=args.paper;this.holder=args.holder;this.$svg=$(this.holder).find("svg");};Util.prototype={getViewBox:function(){var svg=this.$svg.get(0);var vb=svg.getAttribute("viewBox");var r={x:0,y:0,w:parseFloat(svg.getAttribute("width")),h:parseFloat(svg.getAttribute("height"))};if(vb){var vs=vb.split(" ");r.x=parseFloat(vs[0]);r.y=parseFloat(vs[1]);r.w=parseFloat(vs[2]);r.h=parseFloat(vs[3]);};return r;},getRoundRectPath:function(args){var x=args.x,y=args.y,w=args.w,h=args.h,r=args.r,rtl=args.rtl||args.r,rtr=args.rtr||args.r,rbr=args.rbr||args.r,rbl=args.rbl||args.r;var npath=[];npath.push(["M",x+rtl,y
],["H",x+w-rtr
],["C",x+w-rtr,y,x+w,y,x+w,y+rtr
],["V",y+h-rbr
],["C",x+w,y+h-rbr,x+w,y+h,x+w-rbr,y+h
],["H",x+rbl
],["C",x+rbl,y+h,x,y+h,x,y+h-rbl
],["V",y+rtl
],["C",x,y+rtl,x,y,x+rtl,y
],["Z"]);return npath;},getEventPosition:function(e){var vb=this.getViewBox();var of=this.$svg.offset();var r={pageX:e.pageX,pageY:e.pageY,x:(e.pageX-of.left+vb.x),y:(e.pageY-of.top+vb.y)};return r;}} ;function DrawUtil(args){this.paper=args.paper;this.holder=args.holder;this.cb=new ChoserBox({paper:this.paper,holder:this.holder});this.zd=new ZLineDrawer({paper:this.paper,holder:this.holder});this.els={};this.idx=0;this.mode=null;this.init();this.regEvent();};DrawUtil.prototype={pushEl:function(el){if(el){if(!el.id){el.id=-(this.idx++);};this.els[el.id]=el;}},setMode:function(mode){this.mode=mode;var el=null;switch(mode){case"line":el=new Line({paper:this.paper,holder:this.holder});this.cb.setEditable(false);break;case"zline":this.zd.begin();this.cb.setEditable(false);break;default:this.cb.setEditable(true);break;};this.pushEl(el);},init:function(){this.cb.setEditable(false);},onFinished:function(el){},setEditable:function(flag){$.each(this.els,function(key,el){el.setEditable(flag);});},getValue:function(){var r=[];$.each(this.els,function(key,el){var elv=el.getValue();if(elv){elv.id=el.id;r.push(elv);}});return r;},setValue:function(v){for(var i=0;i<v.length;++i){var ev=v[i];var el=null;switch(ev.type){case"line":el=new Line({paper:this.paper,holder:this.holder});break;case"rect":el=new Rect({paper:this.paper,holder:this.holder});break;case"ellipse":el=new Ellipse({paper:this.paper,holder:this.holder});break;case"circle":el=new Ellipse({paper:this.paper,holder:this.holder,type:"circle"});break;case"textarea":el=new TextArea({paper:this.paper,holder:this.holder});break;case"zline":el=new ZLine({paper:this.paper,holder:this.holder});break;};el.setValue(ev);el.id=ev.id;this.pushEl(el);}},remove:function(){$.each(this.els,function(key,el){el.remove();delete this.els[key];});},removeById:function(id){if(this.els[id]){this.els[id].remove();}},regEvent:function(){var ctx=this;this.cb.onFinished=function(p){var el=null;switch(ctx.mode){case"textbox":el=new TextArea({paper:ctx.paper,holder:ctx.holder,pos:{x:p.x1,y:p.y1,w:p.w,h:p.h}});break;case"ellipse":el=new Ellipse({paper:ctx.paper,holder:ctx.holder,pos:{cx:p.cx,cy:p.cy,rx:p.w/2,ry:p.h/2}});break;case"circle":el=new Ellipse({paper:ctx.paper,holder:ctx.holder,pos:{cx:p.cx,cy:p.cy,rx:p.w/2,ry:p.h/2},type:"circle"});break;case"rect":el=new Rect({paper:ctx.paper,holder:ctx.holder,pos:{x:p.x1,y:p.y1,w:p.w,h:p.h,r:0}});break;};ctx.cb.setEditable(false);ctx.onFinished(el);ctx.pushEl(el);};this.zd.onFinished=function(zl){ctx.pushEl(zl);};eve.on("oc_topo_chose",function(){ctx.current=this;});}}; function Chooser(args){this.paper=args.paper;this.holder=args.holder;this.$svg=$(this.holder).find("svg");this.cb=new ChoserBox(args);this.editable=true;this.els=args.els||{};this.chosed=[];this.regEvent();};Chooser.prototype={regEvent:function(){var ctx=this;this.cb.onFinished=function(p){ctx.check(p);setTimeout(function(){ctx.cb.setEditable(false);},100);};this.$svg.click(function(e){if(!ctx.cb.editable&&(e.target.tagName=="svg"||(e.target.obj&&!e.target.obj.editable))){ctx.uncheck();}});eve.on("oc_topo_image_checked",function(){ctx.chosed.push(this);this.checked=true;this.setState("choosed");});eve.on("oc_topo_image_unchecked",function(){this.checked=false;this.setState("normal");ctx.chosed=$.grep(ctx.chosed,function(c){return c.checked;});});eve.on("*.drag.start.*",function(){if(this.parent&&this.parent.checked){for(var i=0;i<ctx.chosed.length;++i){var e=ctx.chosed[i];if(e.checked){e.oldPos=e.getPos();}}}});eve.on("*.drag.move.*",function(dx,dy){if(this.parent&&this.parent.checked){for(var i=0;i<ctx.chosed.length;++i){var e=ctx.chosed[i];if(e.checked){e.refresh({x:e.oldPos.x+dx,y:e.oldPos.y+dy,w:e.oldPos.w,h:e.oldPos.h,cx:e.oldPos.cx,cy:e.oldPos.cy});}}}});$(document).keyup(function(e){if(e.altKey&&e.keyCode==67){ctx.setEditable(true);}});},setEditable:function(flag){this.editable=!!flag;this.cb.setEditable(this.editable);},setEls:function(els){this.els=els;},uncheck:function(){if(this.chosed){for(var i=0;i<this.chosed.length;++i){var e=this.chosed[i];e.checked=false;e.setState("normal");};this.chosed.splice(0,this.chosed.length);}},check:function(p){var ctx=this;this.uncheck();if(this.els&&this.editable){$.each(this.els,function(key,el){if(el.check&&typeof el.check=="function"){if(el.check(ctx.cb)){ctx.chosed.push(el);if(el.setState){el.setState("choosed");}}}});}}}; function Ellipse(args){this.paper=args.paper;this.holder=args.holder;this.pos=$.extend({cx:0,cy:0,rx:0,ry:0},args.pos);this.editable=true;this.type=args.type||"ellipse";this.init();this.sizer=new Sizer({paper:this.paper,holder:this.holder,node:this.ellipse});this.regEvent();};Ellipse.prototype={init:function(){var ctx=this;this.ellipse=this.paper.ellipse(0,0,0,0).attr("fill","red");this.ellipse.getPos=function(){var r={cx:this.attr("cx"),rx:this.attr("rx"),cy:this.attr("cy"),ry:this.attr("ry")};r.x=r.cx-r.rx;r.y=r.cy-r.ry;r.w=2*r.rx;r.h=2*r.ry;return r;};this.node=this.ellipse;this.refresh(this.pos);},getPos:function(){return this.ellipse.getPos();},setState:function(state){switch(state){case"chose":this.sizer.show();break;case"normal":this.sizer.hide();break;}},regEvent:function(){var ctx=this;this.sizer.onFresh=function(p){ctx.refresh({cx:p.cx,cy:p.cy,rx:p.w/2,ry:p.h/2});};this.ellipse.click(function(){ctx.onClick();ctx.toFront();eve("topo_item_blur",ctx);eve("topo_item_focus",ctx);ctx.setState("chose");return false;});eve.on("topo_item_blur",function(){ctx.setState("normal");});this.ellipse.drag(function(dx,dy){if(ctx.editable){this.attr({cx:dx+this.ocx,cy:dy+this.ocy});var p=this.getPos();ctx.sizer.refresh(p);}},function(){this.ocx=this.attr("cx");this.ocy=this.attr("cy");eve("oc_topo_chose",ctx);});},onClick:function(){},onAfterRefresh:function(){},refresh:function(pos){if(this.type=="circle"){pos.rx=pos.ry=pos.rx>pos.ry?pos.ry:pos.rx;};this.ellipse.attr({cx:pos.cx,cy:pos.cy,rx:pos.rx,ry:pos.ry});this.onAfterRefresh();},setEditable:function(flag){this.editable=!!flag;if(this.editable){this.sizer.show();}else{this.sizer.hide();}},toFront:function(){this.sizer.toFront();this.ellipse.toFront();},getValue:function(){var p=this.ellipse.getPos();p.type=this.type;return p;},setValue:function(v){this.ellipse.attr(v);}};function Line(args){this.paper=args.paper;this.holder=args.holder;this.$svg=$(this.holder).find("svg");this.util=new Util(args);this.editable=true;this.firstPoint=null;this.secondPoint=null;this.color="black";this.weight=1;this.style="solid";this.init();this.regEvent();};Line.prototype={init:function(){this.line=this.paper.path("M0 0L0 0");this.node=this.line;},setEditable:function(flag){this.editable=!!flag;},remove:function(){this.line.remove();this.clear();},onFinished:function(){this.setEditable(false);},regEvent:function(){var ctx=this;this.$svg.click(function(e){if(ctx.editable){var p=ctx.util.getEventPosition(e);if(!ctx.firstPoint||!ctx.firstPoint.x){ctx.firstPoint={x:p.x,y:p.y};}else{ctx.secondPoint={x:p.x,y:p.y};ctx.refresh();ctx.onFinished();}}});this.$svg.on("mousemove",function(e){if(ctx.editable){var p=ctx.util.getEventPosition(e);ctx.secondPoint={x:p.x+1,y:p.y+1};ctx.refresh();}});this.line.click(function(){eve("oc_topo_chose",ctx);});},getPos:function(){var p=this.line.attr("path");var r={x1:p[0][1],y1:p[0][2],x2:p[1][1],y2:p[1][2]};r.cx=(r.x1+r.x2)/2;r.cy=(r.y1+r.y2)/2;return r;},getValue:function(){var v=this.getPos();v.angle=this.getAngle();v.type="line";v.color=this.color;v.style=this.style;v.weight=this.weight;return v;},setColor:function(color){this.color=color||this.color;this.line.attr("stroke",color);},setStyle:function(style){this.style=style||this.style;switch(this.style){case"solid":this.line.attr("stroke-dasharray","");break;case"dash":this.line.attr("stroke-dasharray",". ");break;case"interval":this.line.attr("stroke-dasharray","-");break;case"intervalLong":this.line.attr("stroke-dasharray","--");break;}},setWeight:function(weight){this.weight=weight||this.weight;this.line.attr("stroke-width",this.weight);},setValue:function(v){this.line.attr("path",[["M",v.x1,v.y1],["L",v.x2,v.y2]]);this.setColor(v.color);this.setWeight(v.weight);this.setStyle(v.style);},getAngle:function(){var p=this.getPos();var angle=Raphael.angle(p.y1,p.x1,p.y2+1,p.x2,p.y2,p.x2);return angle-90;},showArrow:function(flag){var ctx=this;this.showArrow=!!flag;if(this.showArrow){if(!this.arrow){this.arrow=this.paper.path("M0 0L0 0");this.arrow.refresh=function(){var p=ctx.getPos();p.x=p.x2;p.y=p.y2;p.w=20;this.attr("path",[["M",p.x,p.y],["L",p.x-p.w/2,p.y+Math.sin(Math.PI/3)*p.w],["L",p.x,p.y+p.w/2],["L",p.x+p.w/2,p.y+Math.sin(Math.PI/3)*p.w],["Z"]]);this.transform("r"+ctx.getAngle()+","+p.x+","+p.y);};};this.arrow.show();this.arrow.refresh();}else{this.arrow.hide();}},clear:function(){this.firstPoint=null;this.secondPoint=null;this.line.attr("path","M0 0L0 0");},onBeforeRefresh:function(){},refresh:function(pos){if(this.firstPoint&&this.secondPoint){this.onBeforeRefresh();this.line.attr("path",[["M",this.firstPoint.x,this.firstPoint.y],["L",this.secondPoint.x,this.secondPoint.y]]);}}};function Rect(args){this.paper=args.paper;this.holder=args.holder;this.util=new Util(args);this.editable=true;this.pos=$.extend({x:0,y:0,w:0,h:0,r:0},args.pos);this.init();this.regEvent();};Rect.prototype={init:function(){this.rect=this.paper.path("M0 0L0 0Z").attr("fill","red");this.node=this.rect;this.rect.getPos=function(){return $.extend({x:0,y:0,w:0,h:0,r:0},this.pos);};this.sizer=new Sizer({paper:this.paper,holder:this.holder,node:this.rect});this.refresh(this.pos);this.sizer.refresh(this.pos);this.toFront();},setEditable:function(flag){this.editable=!!flag;this.sizer.setEditable(this.editable);},refresh:function(pos){if(this.editable){this.rect.pos=pos;this.rect.attr("path",this.util.getRoundRectPath(pos));}},setValue:function(v){this.refresh(p);this.sizer.refresh(this.pos);},getValue:function(){var p=this.rect.pos;p.type="rect";return p;},remove:function(){this.rect.remove();this.sizer.remove();},regEvent:function(){var ctx=this;this.sizer.onFresh=function(p){if(ctx.editable){ctx.refresh($.extend(ctx.rect.pos,p));}};this.rect.drag(function(dx,dy){if(ctx.editable){ctx.refresh($.extend(this.pos,{x:dx+this.ox,y:dy+this.oy}));ctx.sizer.refresh(this.pos);}},function(){if(ctx.editable){this.ox=this.pos.x;this.oy=this.pos.y;ctx.toFront();};eve("oc_topo_chose",ctx);});},toFront:function(){this.rect.toFront();this.sizer.toFront();}};function Sizer(args){this.paper=args.paper;this.holder=args.holder;this.node=args.node;this.$svg=$(this.holder).find("svg");this.mode="both";this.editable=true;this.centerFixed=false;this.angle=0;this.dragSet=this.paper.set();this.init();this.regEvent();};Sizer.prototype={regEvent:function(){var ctx=this;this.dragSet.drag(function(dx,dy){ctx.dragMove(dx,dy,this)},function(){ctx.dragStart(this)},function(){ctx.dragEnd(this)});$(this.holder).on("keyup",function(e){});},setEditable:function(flag){this.editable=!!flag;if(this.editable){this.show();}else{this.hide();}},setValue:function(pos){if(pos&&pos.w>0&&pos.h>0){this.tl.attr({x:pos.x-2,y:pos.y-2});this.tc.attr({x:pos.x-2+pos.w/2,y:pos.y-2});this.tr.attr({x:pos.x-2+pos.w,y:pos.y-2});this.rc.attr({x:pos.x-2+pos.w,y:pos.y-2+pos.h/2});this.br.attr({x:pos.x-2+pos.w,y:pos.y-2+pos.h});this.bc.attr({x:pos.x-2+pos.w/2,y:pos.y-2+pos.h});this.bl.attr({x:pos.x-2,y:pos.y-2+pos.h});this.lc.attr({x:pos.x-2,y:pos.y-2+pos.h/2});this.rect.attr({x:pos.x,y:pos.y,width:pos.w,height:pos.h});}},rotage:function(angle){this.angle=angle||this.angle;var p=this.node.getPos();var trs=[["r",this.angle,p.cx,p.cy]];this.dragSet.transform(trs);this.rect.transform(trs);if(this.node.rotage){this.node.rotage(trs);}},dragMove:function(dx,dy,re){if(this.editable){var pos=re.pos;switch(re.type){case"tl":re.attr({x:dx+re.ox,y:dy+re.oy});pos.w=pos.x-re.attr("x")+pos.w;pos.h=pos.y-re.attr("y")+pos.h;pos.x=re.attr("x");pos.y=re.attr("y");break;case"tr":re.attr({x:dx+re.ox,y:dy+re.oy});pos.w=re.attr("x")-pos.x;pos.h=pos.y-re.attr("y")+pos.h;pos.x=re.attr("x")-pos.w;pos.y=re.attr("y");break;case"br":re.attr({x:dx+re.ox,y:dy+re.oy});pos.w=re.attr("x")-pos.x;pos.h=re.attr("y")-pos.y;pos.x=re.attr("x")-pos.w;pos.y=re.attr("y")-pos.h;break;case"bl":re.attr({x:dx+re.ox,y:dy+re.oy});pos.w=pos.x-re.attr("x")+pos.w;pos.h=re.attr("y")-pos.y;pos.x=re.attr("x");pos.y=re.attr("y")-pos.h;break;case"tc":re.attr({y:dy+re.oy});pos.h=pos.y-re.attr("y")+pos.h;pos.y=re.attr("y");break;case"rc":re.attr({x:dx+re.ox});pos.w=re.attr("x")-pos.x;pos.x=re.attr("x")-pos.w;break;case"bc":re.attr({y:dy+re.oy});pos.h=re.attr("y")-pos.y;pos.y=re.attr("y")-pos.h;break;case"lc":re.attr({x:dx+re.ox});pos.w=pos.x-re.attr("x")+pos.w;pos.x=re.attr("x");break;};pos.cx=pos.x+pos.w/2;pos.cy=pos.y+pos.h/2;this.refresh(pos);}},dragStart:function(re){if(this.editable){re.ox=re.attr("x");re.oy=re.attr("y");re.pos=this.node.getPos();}},dragEnd:function(){},refresh:function(pos){if(this.editable){this.setValue(pos);this.onFresh(pos);}},remove:function(){this.dragSet.remove();this.rect.remove();},hide:function(){this.dragSet.hide();this.rect.hide();},show:function(){this.dragSet.show();this.rect.show();},onFresh:function(pos){},init:function(){var pos=this.node.getPos();this.rect=this.paper.rect(pos.x,pos.y,pos.w,pos.h);this.tl=this.paper.rect(pos.x-2,pos.y-2,4,4).attr({fill:"white",cursor:"nw-resize"});this.tl.type="tl";this.tc=this.paper.rect(pos.x-2+pos.w/2,pos.y-2,4,4).attr({fill:"white",cursor:"n-resize"});this.tc.type="tc";this.tr=this.paper.rect(pos.x-2+pos.w,pos.y-2,4,4).attr({fill:"white",cursor:"ne-resize"});this.tr.type="tr";this.rc=this.paper.rect(pos.x-2+pos.w,pos.y-2+pos.h/2,4,4).attr({fill:"white",cursor:"e-resize"});this.rc.type="rc";this.br=this.paper.rect(pos.x-2+pos.w,pos.y-2+pos.h,4,4).attr({fill:"white",cursor:"se-resize"});this.br.type="br";this.bc=this.paper.rect(pos.x-2+pos.w/2,pos.y-2+pos.h,4,4).attr({fill:"white",cursor:"s-resize"});this.bc.type="bc";this.bl=this.paper.rect(pos.x-2,pos.y-2+pos.h,4,4).attr({fill:"white",cursor:"sw-resize"});this.bl.type="bl";this.lc=this.paper.rect(pos.x-2,pos.y-2+pos.h/2,4,4).attr({fill:"white",cursor:"w-resize"});this.lc.type="lc";this.dragSet.push(this.tl,this.tc,this.tr,this.rc,this.br,this.bc,this.bl,this.lc);},toFront:function(){this.rect.toFront();this.dragSet.toFront();}};function TextArea(args){this.paper=args.paper;this.pos=$.extend({x:0,y:0,w:0,h:0},args.pos);this.holder=args.holder;this.fontSize=12;this.fontColor="black";this.$svg=$(this.holder);this.editable=true;this.util=new Util(args);this.init();};TextArea.prototype={init:function(){this.fp=this.paper.rect(this.pos.x,this.pos.y,this.pos.w,this.pos.h).attr({fill:"white","fill-opacity":"0.0001","stroke":null});this.node=this.fp;this.bg=this.paper.rect(this.pos.x,this.pos.y,this.pos.w,this.pos.h).attr({fill:"white","fill-opacity":"0.01"});this.bg.toBack();this.ipter=$("<textarea style=\"position:absolute;display:none;z-index:10000;color:black;\"/>");this.texts=this.paper.set();this.$svg.css({"position":"relative"});this.$svg.append(this.ipter);this.sizer=new Sizer({paper:this.paper,node:this});this.regEvent();},regEvent:function(){var ctx=this;this.ipter.on("blur",function(){$(this).css({"display":"none"});ctx.setText($(this).val());});this.fp.drag(function(dx,dy){if(ctx.editable){this.attr({x:this.ox+dx,y:this.oy+dy});ctx.refresh(ctx.getPos());if(dx>0||dy>0){this.clickTime=0;}}},function(){if(ctx.editable){this.ox=this.attr("x");this.oy=this.attr("y");ctx.sizer.hide();if(!this.clickTime)this.clickTime=0;setTimeout(function(){ctx.fp.clickTime=0;clearInterval(this);},500);this.clickTime++;};ctx.toFront();eve("oc_topo_chose",ctx);},function(e){if(ctx.editable){ctx.sizer.show();ctx.sizer.refresh(ctx.getPos());if(this.clickTime==2){var pos=ctx.getPos();ctx.ipter.css({"display":"block"});ctx.refresh(pos);ctx.ipter.focus();this.clickTime=0;}};return e;});this.sizer.onFresh=function(pos){ctx.refresh(pos);};},setEditable:function(flag){this.editable=!!flag;if(this.editable){this.sizer.show();this.bg.attr("stroke","black");};if(!this.editable){this.sizer.hide();this.bg.attr("stroke",null);}},toFront:function(){this.bg.toFront();this.texts.toFront();this.fp.toFront();this.sizer.toFront();},getPos:function(){var r={w:this.fp.attr("width"),h:this.fp.attr("height"),x:this.fp.attr("x"),y:this.fp.attr("y")};r.cx=r.x+r.w/2;r.cy=r.y+r.h/2;return r;},drawText:function(t,x,y){var p=this.getPos();if(y<p.h+p.y){var text=this.paper.text(x,y,"").attr({"font-size":this.fontSize,"text-anchor":"start","space":"preserve",fill:this.fontColor});text.node.innerHTML=t.replace(/\s/g,"&nbsp;&nbsp;");this.texts.push(text);}},setText:function(t){if(t&&this.editable){this.text=t;var p=this.getPos();var margin=4;var prw=p.w-12-this.fontSize;this.texts.remove();var rw=0;var b=0;var preX=p.x+6;var preY=p.y+this.fontSize;for(var i=0;i<t.length;++i){if(t[i].match(/[^\x00-\xff]/)){rw+=this.fontSize;}else if(t[i].match(/[\-\,\.\?\:\;\'\"\!\`]/)){rw+=Math.floor(this.fontSize/4);}else if(t[i].match(/[\x00-\xff\S"]/)){rw+=Math.floor(this.fontSize/2);};if((rw>=prw||t[i].match(/[\n]/))){this.drawText(t.substring(b,i+1),preX,preY);rw=0;b=i+1;preY+=margin+this.fontSize;}};this.drawText(t.substring(b,i),preX,preY);this.toFront();}},getValue:function(){var p=this.getPos();p.text=this.text||"";p.type="textarea";p.fontSize=this.fontSize;p.fontColor=this.fontColor;return p;},setValue:function(cfg){this.refresh(cfg);this.fontSize=cfg.fontSize||this.fontSize;this.fontColor=cfg.fontColor||this.fontColor;this.setText(cfg.text);},refresh:function(pos){if(this.editable&&pos&&pos.w>this.fontSize*2&&pos.h>0){var vb=this.util.getViewBox();this.fp.attr({x:pos.x,y:pos.y,width:pos.w,height:pos.h});this.bg.attr({x:pos.x,y:pos.y,width:pos.w,height:pos.h});this.ipter.css({left:pos.x-vb.x,top:pos.y-vb.y,"width":pos.w,"height":pos.h,"backgroundColor":"white"});this.setText(this.text);}},remove:function(){this.fp.remove();this.bg.remove();this.texts.remove();}};function ZLine(args){this.paper=args.paper;this.ajw=6;this.adw=8;this.editable=true;this.lines=this.paper.set();this.node=this.lines;this.lineStyle="solid";this.weight=1;this.color="black";this.adjusters=this.paper.set();this.points=[];};ZLine.prototype={begin:function(p){this.points.push(p);},step:function(p){if(p){var l=this.line(this.top(this.points),p);this.lines.push(l);this.points.push(p);}},end:function(p){this.step(p);this.drawAdjuster();},line:function(p1,p2){var ctx=this;var l=this.paper.path([["M",p1.x,p1.y],["L",p2.x,p2.y]]);l.getPos=function(){var p=this.attr("path");var r={x1:p[0][1],y1:p[0][2],x2:p[1][1],y2:p[1][2]};r.cx=(r.x1+r.x2)/2;r.cy=(r.y1+r.y2)/2;return r;};l.glowSet=l.glow({width:10,opacity:0.01,color:"orange","cursor":"pointer"});l.refresh=function(a,b){this.attr("path",[["M",a.x,a.y],["L",b.x,b.y]]);this.glowSet.attr("path",[["M",a.x,a.y],["L",b.x,b.y]]);if(this.adder)this.adder.remove();};var oldHide=l.hide;l.hide=function(){this.glowSet.hide();oldHide.call(this);};var oldRm=l.remove;l.remove=function(){ctx.lines.splice(this.idx,1);this.glowSet.remove();oldRm.call(this);};l.glowSet.click(function(){ctx.adder(l);ctx.toFront();l.adder.toFront();eve("oc_topo_chose",ctx);});l.click(function(){ctx.adder(l);ctx.toFront();l.adder.toFront();eve("oc_topo_chose",ctx);});return l;},setWeight:function(weight){this.weight=weight||this.weight;this.lines.attr({"stroke-width":weight});},setStyle:function(style){this.lineStyle=style||this.lineStyle;switch(this.lineStyle){case"solid":this.lines.attr("stroke-dasharray","");break;case"dash":this.lines.attr("stroke-dasharray",". ");break;case"interval":this.lines.attr("stroke-dasharray","-");break;case"intervalLong":this.lines.attr("stroke-dasharray","--");break;}},setColor:function(color){this.color=color||this.color;this.lines.attr("stroke",color);},adder:function(l){var ctx=this;if(!l.adder&&this.editable){var p=l.getPos();var r=ctx.paper.rect(p.cx-ctx.adw/2,p.cy-ctx.adw/2,ctx.adw,ctx.adw).attr({fill:"blue",cursor:"move","stroke-dasharray":"- "});l.adder=r;r.line=l;r.drag(function(dx,dy){this.attr({x:dx+this.ox,y:dy+this.oy});var p={x:this.attr("x")+ctx.adw/2,y:this.attr("y")+ctx.adw/2};var po=this.line.getPos();this.l1.refresh({x:po.x1,y:po.y1},p);this.l2.refresh(p,{x:po.x2,y:po.y2});},function(){this.ox=this.attr("x");this.oy=this.attr("y");var p={x:this.ox+ctx.adw/2,y:this.oy+ctx.adw/2};var po=this.line.getPos();this.l1=ctx.line({x:po.x1,y:po.y1},p);this.l2=ctx.line(p,{x:po.x2,y:po.y2});this.l1.attr(this.line.attrs);this.l2.attr(this.line.attrs);this.line.hide();},function(){var ad=ctx.adjuster(this.l1,this.l2);ctx.lines.splice(this.line.idx+1,0,this.l1,this.l2);ctx.adjusters.splice(this.line.idx,0,ad);this.line.adder=null;this.line.remove();this.remove();ctx.updateRelation();});};ctx.updateRelation();l.adder.toFront();return l.adder;},toFront:function(){this.lines.toFront();this.adjusters.toFront();},drawAdjuster:function(){for(var i=1;i<this.lines.length;++i){var l1=this.lines[i-1];var l2=this.lines[i];this.adjusters.push(this.adjuster(l1,l2));};this.updateRelation();},adjuster:function(l1,l2){var p1=l1.getPos(),p2=l2.getPos();var r=this.paper.rect(p1.x2-this.ajw/2,p1.y2-this.ajw/2,this.ajw,this.ajw).attr({"fill":"white","cursor":"move"});r.l1=l1;r.l2=l2;var ctx=this;r.getPos=function(){var r={x:this.attr("x"),y:this.attr("y"),w:ctx.ajw,h:ctx.ajw};r.cx=r.x+r.w/2;r.cy=r.y+r.h/2;return r;};r.refresh=function(x,y){this.attr({x:x,y:y});};var oldRm=r.remove;r.remove=function(){ctx.adjusters.splice(this.idx,1);oldRm.call(this);};r.drag(function(dx,dy){this.attr({x:dx+this.ox,y:dy+this.oy});var p1=this.l1.getPos(),p2=this.l2.getPos(),p=this.getPos();this.l1.refresh({x:p1.x1,y:p1.y1},{x:p.cx,y:p.cy});this.l2.refresh({x:p.cx,y:p.cy},{x:p2.x2,y:p2.y2});},function(){this.ox=this.attr("x");this.oy=this.attr("y");},function(){var p1=this.l1.getPos(),p2=this.l2.getPos(),p=this.getPos();var angle=Math.abs(Raphael.angle(p1.x1,p1.y1,p2.x2,p2.y2,p.cx,p.cy))%180;if(angle>170||angle<10){ctx.minusLine(this);}});return r;},minusLine:function(aj){var l1=aj.l1,l2=aj.l2;var p1=l1.getPos(),p2=l2.getPos();l1.refresh({x:p1.x1,y:p1.y1},{x:p2.x2,y:p2.y2});l2.remove();aj.remove();this.updateRelation();},top:function(a){return a[a.length-1];},updateRelation:function(){for(var i=0;i<this.lines.length;++i){this.lines[i].idx=i;if(i>0){var ad=this.adjusters[i-1];if(ad){ad.l1=this.lines[i-1];ad.l2=this.lines[i];ad.idx=i-1;ad.toFront();}}};if(this.lines.length<=this.adjusters.length){for(i=this.lines.length-1;i<this.adjusters.length;++i){if(this.adjusters[i]){this.adjusters[i].remove();}}}},setEditable:function(flag){this.editable=!!flag;if(!flag){this.adjusters.hide();}else{this.adjusters.show();}},getValue:function(){var retn=[];var fl=this.lines[0];if(fl){var fp=fl.getPos();retn.push({x:fp.x1,y:fp.x2});};$.each(this.lines,function(idx,l){var p=l.getPos();retn.push({x:p.x2,y:p.y2});});var r={type:"zline",color:this.color,style:this.lineStyle,weight:this.weight,points:retn};return r;},setValue:function(v){for(var i=1;i<v.points.length;++i){this.lines.push(this.line(v.points[i-1],v.points[i]));};this.drawAdjuster();this.setStyle(v.style);this.setWeight(v.weight);this.setColor(v.color);}}; function ZLineDrawer(args){this.paper=args.paper;this.holder=args.holder;this.$svg=$(this.holder).find("svg");this.liner=new Line(args);this.init();this.regEvent();};ZLineDrawer.prototype={init:function(){this.liner.setEditable(false);},begin:function(){this.zline=new ZLine({paper:this.paper});this.zline.firstTime=true;this.liner.setEditable(true);},onFinished:function(zline){},regEvent:function(){var ctx=this;this.liner.onFinished=function(){var v=this.getValue();if(ctx.zline.firstTime){ctx.zline.begin({x:v.x1,y:v.y1});ctx.zline.firstTime=false;};ctx.zline.step({x:v.x2,y:v.y2});this.firstPoint.x=v.x2;this.firstPoint.y=v.y2;this.refresh();};this.$svg.on("mousedown",function(e){if(e.button==2&&ctx.liner&&ctx.liner.editable){ctx.liner.setEditable(false);ctx.liner.clear();ctx.zline.end();ctx.onFinished(ctx.zline);}});}};function Image(args){this.paper=args.paper;this.holder=args.holder;this.attr=args.attr;this.angle=0;this.state="normal";this.editable=true;this.init();this.regEvent();};Image.prototype={init:function(){this.img=this.paper.image(this.attr.src,this.attr.x,this.attr.y,this.attr.w,this.attr.h);this.sizer=new Sizer({paper:this.paper,holder:this.holder,node:this});this.img.parent=this;},setEditable:function(flag){this.editable=!!flag;this.sizer.setEditable(this.editable);if(!this.editable){this.setState("normal");}},remove:function(){this.img.remove();this.sizer.remove();delete this.img;delete this.sizer;delete this;},getPos:function(){var r={x:this.img.attr("x"),y:this.img.attr("y"),w:this.img.attr("width"),h:this.img.attr("height")};r.cx=r.x+r.w/2;r.cy=r.y+r.h/2;return r;},rotage:function(angle){this.angle=angle||this.angle;var p=this.getPos();if((this.angle/90)%2!=0){this.img.transform([["r",this.angle,p.cx,p.cy],["s",p.h/p.w,p.w/p.h]]);}else{this.img.transform("r"+this.angle+","+p.cx+","+p.cy);}},regEvent:function(){var ctx=this;this.sizer.onFresh=function(pos){ctx.img.transform("");ctx.img.attr({x:pos.x,y:pos.y,width:pos.w,height:pos.h});ctx.rotage();};this.img.click(function(e){e.target.obj=ctx;if(e.ctrlKey){if(!ctx.checked){eve("oc_topo_image_checked",ctx);}else{eve("oc_topo_image_unchecked",ctx);}};if(ctx.editable){ctx.toFront();};eve("oc_topo_image_clicked",ctx);});this.img.drag(function(dx,dy){if(ctx.editable){this.attr({x:dx+this.ox,y:dy+this.oy});ctx.sizer.refresh(ctx.getPos());}},function(){this.ox=this.attr("x");this.oy=this.attr("y");},function(){});},setValue:function(v){this.img.attr("src",v.src);this.rotage(v.angle);this.refresh(v);},getValue:function(){var r=this.getPos();r.src=this.img.attr("src");r.angle=this.angle;return r;},toFront:function(){this.img.toFront();this.sizer.toFront();},refresh:function(p){if(this.editable){this.img.attr(p);this.sizer.refresh(p);}},check:function(cb){if(this.editable){this.checked=Raphael.isBBoxIntersect(cb.border.getBBox(),this.img.getBBox());};return!!this.checked;},setState:function(s){this.state=s||this.state;switch(this.state){case"choosed":this.img.attr("opacity",0.5);break;case"normal":this.img.attr("opacity",1);break;}},getState:function(){this.state;}};
