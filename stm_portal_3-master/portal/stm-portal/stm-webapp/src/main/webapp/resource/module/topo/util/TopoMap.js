function TopoMapView(a){this.args=$.extend({onLoad:function(){}},a);this.map=$("#topo_holder").parent().find(".topo_map");this.map.css({position:"absolute",top:"0",left:"0",right:"0",bottom:"0"});this.map&&0!=this.map.length||(this.map=$("<div/>"),this.map.addClass("topo_map"),$("#topo_holder").after(this.map));this.map.show();var b=this,c=(new Date).getTime();this.map.load(oc.resource.getUrl("resource/module/map/map.html"),function(){var a=setInterval(function(){console.log("加载地图用时"+((new Date).getTime()-
c)+"ms");b.init();clearInterval(a)},500)})}
TopoMapView.prototype={init:function(a){if(a=$("#court-map>svg").get(0)){var b=SVG(a),c=b.first(),d=c.group();d.backward();oc.topo.map={flowFlag:!1,draw:d,draw0:b,draw1:c.get(0),draw2:c.get(1),draw3:c.get(2),holder:a,menu:new TopoMapMenu,effect:new TopoMapEffect(b),util:new TopoUtil};oc.topo.map.graph=new TopoMapGraph;oc.topo.map.flowlist=new TopoMapFlowList({holder:this.map});oc.topo.map.paperPath=Raphael(a,1,1).path("M0,0L1,1");oc.topo.map.countryList=new TopoMapCountryList({holder:this.map,onLoad:function(){this.hide()}});
oc.topo.map.levelInfo=new TopoMapLevelInfo({holder:this.map,onLoad:function(){}});this.graph=oc.topo.map.graph;this.regEvent();this.graph.toMap(1,1)}},regEvent:function(){var a=["#F96E03","#47C21F","#F10000","#F5CC00","#71716D"],b=this;eve.on("topo.map.dbclick",function(a,d,e){var f=oc.topo.map,g=null;e||(d+=1);g=1==d?f.draw1:2==d?f.draw2:3==d?f.draw3:f.draw1;e=g.transform();f.scale={x:e.scaleX,y:e.scaleY};f.move={x:e.x,y:e.y};b.graph.remove();b.graph.toMap(a,d);b.fromNode=null});this.map.on("click",
".topoMapPathClass",function(a){a.stopPropagation();if(3==b.graph.level||oc.module.topo.map.isCharteredCities(oc.topo.map.graph.mapid)){oc.topo.map.flowlist.hide();oc.topo.map.countryList.show();var d=$(this);$.post(oc.resource.getUrl("topo/map/node/getCountryList.htm"),{key:d.attr("key"),level:b.graph.level},function(a){oc.topo.map.countryList.setValue({title:d.parent().find("text").text(),nodes:a.info})},"json")}else oc.topo.map.flowlist.show(),oc.topo.map.countryList.hide(),(a=$(this).attr("key"))&&
oc.topo.map.flowlist.toMap(a)});this.map.on("click","svg",function(a){oc.topo.map.flowlist.show();oc.topo.map.countryList.hide();oc.topo.map.flowlist.toMap(oc.topo.map.graph.getMapId());a.stopPropagation()});this.map.on("click","image",function(c){c.stopPropagation();var d=$(this);if(c=d.data("id"))b.fromNode?c!=b.fromNode.data("id")&&$.post(oc.resource.getUrl("topo/map/line/addLine.htm"),{fromId:b.fromNode.data("id"),toId:c,mapid:b.graph.mapid||0},function(c){200==c.status?(b.graph.addLine({from:b.fromNode,
to:d,style:{stroke:a[Math.floor(6*Math.random())],"stroke-width":1}}).setData(c.line),alert(c.msg)):alert(c.msg,"warning");b.fromNode=null},"json"):b.fromNode=d});this.map.on("dblclick","image",function(){var a=$(this).data("db");b.fromNode=null;a&&a.instanceId?oc.util.ajax({url:oc.resource.getUrl("topo/resource/checkauth.htm"),data:{instanceId:a.instanceId},success:function(b){200==b.state?oc.resource.loadScript("resource/module/resource-management/resourceDetailInfo/js/detailnewInfo.js",function(){oc.module.resmanagement.resdeatilinfonew.open({instanceId:a.instanceId})}):
alert(b.msg,"warning")}}):alert("此节点未关联资源实例，请右键关联","warning")});this.map.on("contextmenu","image",function(a){b.hideTooltip();oc.topo.map.menu.show("node",a,$(this));a.stopPropagation();a.preventDefault()});this.map.on("contextmenu",".topo_map_line",function(a){oc.topo.map.menu.show("line",a,$(this));a.stopPropagation();a.preventDefault()});this.map.on("contextmenu",function(a){a.stopPropagation();a.preventDefault()});this.map.on("mouseover","image",function(a){oc.topo.tips||(oc.topo.tips=new TopoNewTip);
var d=$(this).data("db");b.timeAfter(function(){d&&d.instanceId?$.post(oc.resource.getUrl("topo/resource/nodeTooltip.htm"),{instanceId:d.instanceId},function(b){b.instanceId=d.instanceId;oc.topo.tips.show({type:"node",x:a.pageX,y:a.pageY,value:b})},"json"):alert("未关联资源","warning")},600,"topo_map_node")});this.map.on("mouseout","image",function(a){b.hideTooltip()})},hideTooltip:function(){clearTimeout(this.topo_map_node);oc.topo.tips&&oc.topo.tips.hide()},timeAfter:function(a,b,c,d){var e=this;e[c]?
(clearTimeout(e[c]),e[c]=null):e[c]=setTimeout(function(){a.apply(d||e);e[c]=null},b||500)},show:function(){this.map.removeClass("hide");$("#topo_holder").addClass("hide");oc.topo.topo&&oc.topo.topo.topoSizerBar&&oc.topo.topo.topoSizerBar.hide()},hide:function(){this.map.addClass("hide");$("#topo_holder").removeClass("hide");oc.topo.topo.topoSizerBar&&oc.topo.topo.topoSizerBar.show()}};function TopoMapGraph(a){this.args=$.extend({draw:oc.topo.map.draw.next()},a);this.lines={}}
TopoMapGraph.prototype={toMap:function(a,b){oc.topo.map.util.beginLog("TopoMapGraph.toMap");var c=this.searchNode(),d=this;this.mapid=a;this.level=b;$.post(oc.resource.getUrl("topo/map/graph/get.htm"),{id:this.mapid},function(a){var b={},g=d.drawLine(c,a.data.lines,b);a=d.drawNodes(c,a.data.nodes,b);d.refreshState(a,g,b);oc.topo.map.util.endLog("TopoMapGraph.toMap")},"json");this.refreshHealthyStatus()},refreshHealthyStatus:function(){$.post(oc.resource.getUrl("topo/map/graph/levelInfo.htm"),{level:this.level,
mapid:this.mapid},function(a){200==a.status?oc.topo.map.levelInfo.setValue(a):alert(a.msg,"warning")},"json")},setState:function(a,b){if(a instanceof TopoMapLine)a.setState(b);else{var c="";switch(b){case "none":c="module/map/img/gaofa_white.png";break;case "nodata":c="module/map/img/gaofa_gray.png";break;case "danger":c="module/map/img/gaofa_red.png";break;case "disabled":c="module/map/img/gaofa_white.png";break;case "warning":c="module/map/img/gaofa_yellow.png";break;case "normal":c="module/map/img/gaofa_green.png";
break;case "severity":c="module/map/img/gaofa_orange.png"}a.attr("href",oc.resource.getUrl("resource/"+c))}},refreshState:function(a,b,c){function d(d,g){$.post(oc.resource.getUrl("topo/refreshState.htm"),{nodeInstIds:a.join(","),linkInstIds:b.join(","),linkMetricId:d,nodeMetricId:g},function(a){if(a.data)for(var b=0;b<a.data.length;b++)for(var d=a.data[b],f=c[d.instanceId],g=0;g<f.length;g++)e.setState(f[g],d.state)},"json")}var e=this;$.post(oc.resource.getUrl("topo/setting/get/globalSetting.htm"),
function(a){a=$.extend({link:{colorWarning:"device"},device:{colorWarning:"device"}},a);d(a.link.colorWarning,a.device.colorWarning)},"json")},searchNode:function(){var a={},b=this.args.draw;b&&b.each&&b.each(function(b,d){a[this.data("id")]=this});return a},getMapId:function(){return this.mapid},drawLine:function(a,b,c){for(var d=[],e=0;e<b.length;e++){var f=b[e],g=a[f.fromId],h=a[f.toId];g&&h&&((g=this.addLine({from:g,to:h}))&&g.setData(f),f.instanceId&&(d.push(f.instanceId),c[f.instanceId]||(c[f.instanceId]=
[]),c[f.instanceId].push(g)))}return d},drawNodes:function(a,b,c){for(var d=[],e=[],f=0;f<b.length;f++){var g=b[f],h=a[g.nodeid];if(h){h.data("db",g);g.instanceId&&(d.push(g.instanceId),c[g.instanceId]||(c[g.instanceId]=[]),c[g.instanceId].push(h));if(g.instanceId&&!g.nextMapId){var k=this.getMapIdForPoint(h);e.push({nextMapId:k,level:this.level,id:g.id});g.nextMapId=k;g.level=this.level;h.data("db",g)}h.attr("key",g.nextMapId)}}0<e.length&&$.post(oc.resource.getUrl("topo/map/node/updateNextMapIdAndLevel.htm"),
{nodes:JSON.stringify(e)},function(a){200==a.status?alert("更新成功!"):alert(a.msg,"warning")},"json");return d},getMapIdForPoint:function(a){var b=oc.module.topo.map.getErrorAreaPonit(),c=a.data("id");if(c&&b[c])return b[c];if(a.attr("key"))return a.attr("key");c=oc.topo.map["draw"+this.level];b=oc.topo.map.paperPath;if(c)for(var d=$(c.node),c=parseFloat(a.attr("x")),e=parseFloat(a.attr("y")),d=d.find(".topoMapPathClass"),f=0;f<d.length;f++){var g=$(d[f]);b.attr("path",g.attr("d"));if(b.isPointInside(c,
e))return b=g.attr("key"),a.attr("key",b),b}},getValue:function(){for(var a=[],b=0;b<this.lines.length;b++){var c=this.lines[b];a.push({from:c.fromNode.data("id"),to:c.toNode.data("id")})}return a},reset:function(){this.lines={}},addLine:function(a){if(a.from&&a.to){var b={x:parseFloat(a.from.attr("x"))+parseFloat(a.from.attr("width"))/2,y:parseFloat(a.from.attr("y"))+parseFloat(a.from.attr("height"))/2},c={x:parseFloat(a.to.attr("x"))+parseFloat(a.to.attr("width"))/2,y:parseFloat(a.to.attr("y"))+
parseFloat(a.to.attr("height"))/2},d=null,d=b.x<=c.x?new TopoMapLine({from:this.convertPoint(b),to:this.convertPoint(c),style:a.style}):new TopoMapLine({from:this.convertPoint(c),to:this.convertPoint(b),style:a.style,glowReverse:!0});d.addFlow();d.setState("橙色");d.fromNode=a.from;d.toNode=a.to;return this.lines[d.line.attr("id")]=d}},remove:function(){for(var a in this.lines)this.lines[a].remove();this.reset()},convertPoint:function(a){if(oc.topo.map.scale){var b=oc.topo.map.scale;a.x*=b.x;a.y*=b.y}oc.topo.map.move&&
(b=oc.topo.map.move,a.x+=b.x,a.y+=b.y);return a}};function TopoMapLine(a){this.args=$.extend({from:{x:0,y:0},to:{x:0,y:0},glowReverse:!1,angle:Raphael.rad(40)},a);this.args.style=$.extend({fill:"none",stroke:"#4cc829","stroke-width":2},this.args.style);this.init()}
TopoMapLine.prototype={init:function(){var a=this.args.from,b=this.args.to,c=oc.topo.map.draw,d=this.getControllPoint();this.line=c.path("M"+a.x+","+a.y+"Q"+d.x+","+d.y+","+b.x+","+b.y);this.line.addClass("topo_map_line");this.line.attr(this.args.style);c.add(this.line);this.regEvent()},setState:function(a){var b=null;this.glow&&this.glow.show();this.disabledTag&&this.disabledTag.hide();switch(a){case "warning":b="#f6cb00";break;case "normal":b="#4cc829";break;case "severity":b="#f10000";break;case "danger":b=
"#f96e05";break;case "notlink":b="#ffffff";break;case "not_monitored":b="#06d1ef";break;case "nodata":b="#a4a4a0";break;case "disabled":b="#a4a4a0";this.glow&&this.glow.hide();this.disabledTag?this.disabledTag.show():this.addDisable();break;default:b="#ffffff"}this.line.style("stroke",b);this.glow&&this.glow.style("fill",b)},setData:function(a){this.data=a;this.line.data("db",a)},getData:function(){return this.data||{}},regEvent:function(){var a=this;this.line.on("mouseover",function(b){a.line.attr({"stroke-width":3});
oc.topo.tips||(oc.topo.tips=new TopoNewTip);var c=a.line.data("db");c&&c.instanceId&&a.timeAfter(function(){oc.topo.tips.show({type:"link",x:b.pageX,y:b.pageY,value:{instanceId:c.instanceId}})},600,"topo_map")});this.line.on("mouseout",function(){a.line.attr({"stroke-width":a.args.style["stroke-width"]});clearTimeout(a.topo_map);oc.topo.tips&&oc.topo.tips.hide()})},timeAfter:function(a,b,c,d){var e=this;e[c]?(clearTimeout(e[c]),e[c]=null):e[c]=setTimeout(function(){a.apply(d||e);e[c]=null},b||500)},
addDisable:function(){this.disabledTag=oc.topo.map.draw.text("×").font({size:16}).fill({color:"red"});var a=this.line.length(),a=this.line.pointAt(a/2);this.disabledTag.move(a.x-5,a.y-9)},addFlow:function(){var a=oc.topo.map.effect,b=oc.topo.map.draw,c=this;if(a&&b){var d=this.args.from;this.glow=b.use(a.lineEffect).translate(d.x,d.y).style({fill:this.args.style.stroke});var e=this.line.length();this.glow.animate(parseFloat(e)/30*1E3).during(function(a){a*=e;var b=null,b=c.args.glowReverse?c.line.pointAt(e-
a):c.line.pointAt(a);c.glow.translate(b.x,b.y)}).loop(!0,!0);this.glow.back()}},getControllPoint:function(){var a=this.args.from,b=this.args.to,c=this.args.angle,d=(a.y-b.y)/(a.x-b.x);if(!d||20<d)d=20;k1=d-c;k2=d+c;a=(b.y-a.y+k1*a.x-k2*b.x)/(k1-k2);return{x:a,y:k2*(a-b.x)+b.y}},remove:function(){this.line.remove();this.glow&&this.glow.remove();this.disabledTag&&this.disabledTag.remove()}};function TopoMapFlow(a){this.args=$.extend({svg:null,path:null},a);this.init()}TopoMapFlow.prototype={};function TopoMapEffect(a){this.draw=a;this.init()}
TopoMapEffect.prototype={init:function(){this.lineEffect=this.lineGlow()},lineGlow:function(){var a=this.draw,b=a.gradient("radial",function(a){a.at({offset:"0%",color:"white",opacity:1});a.at({offset:"10%",color:"white",opacity:.95});a.at({offset:"15%",color:"white",opacity:.9});a.at({offset:"30%",color:"white",opacity:.35});a.at({offset:"100%",color:"white",opacity:0})}),b=a.mask().add(a.circle(20).attr({cx:0,cy:0}).style({fill:b})),c=a.group();c.circle(20).attr({cx:0,cy:0}).maskWith(b);a.defs().add(c);
return c}};function TopoMapLevelInfo(a){this.args=$.extend({holder:null,onLoad:function(){}},a);var b=this;if(this.args.holder)oc.util.ajax({url:oc.resource.getUrl("resource/module/topo/map/TopoMapLevelInfo.html"),success:function(a){b.init(a)},type:"get",dataType:"html"});else throw"bad arguments";}
TopoMapLevelInfo.prototype={init:function(a){this.root=$(a);this.root.appendTo(this.args.holder);this.fields={};var b=this;this.root.find("[data-field]").each(function(a,d){var e=$(d);b.fields[e.attr("data-field")]=e});this.args.onLoad.call(this)},setValue:function(a){var b=this.fields;b.level1.hide();for(var c=1;c<a.level;c++)b["level"+c].hide();for(c=a.level;4>=c;c++)b["level"+c].show(),this.fillLevel(b["level"+c],a["level"+c])},fillLevel:function(a,b){a.find(".available").text(b.available);a.find(".amount").text(b.amount)}};function TopoMapCountryInfo(a){var b=this;this.args=$.extend({onOk:function(){b.root.dialog("close")},onLoad:function(){}},a);this.coreInstanceId=null;oc.util.ajax({url:oc.resource.getUrl("resource/module/topo/map/TopoMapCountryInfo.html"),success:function(a){b.init(a)},dataType:"html",type:"get"})}
TopoMapCountryInfo.prototype={init:function(a){this.root=$(a);this.fields={};ctx=this;this.root.find("[data-field]").each(function(a,c){var d=$(c);ctx.fields[d.attr("data-field")]=d});this.root.dialog({width:1E3,height:338,title:"下级资源管理",buttons:[{text:"确定",handler:function(){ctx.args.onOk.call(ctx)}},{text:"取消",handler:function(){ctx.root.dialog("close")}}]});this.pickgrid=oc.ui.pickgrid({leftOptions:{idField:"ip",loadFilter:function(a){return a instanceof Array?{total:a.length,rows:a}:{total:0,
rows:[]}}},leftColumns:[[{field:"id",checkbox:!0},{field:"ip",title:"IP",width:90,ellipsis:!0},{field:"showName",title:"设备名称",width:90,ellipsis:!0},{field:"typeName",title:"设备类型",width:90,ellipsis:!0}]],rightOptions:{idField:"ip",loadFilter:function(a){return a instanceof Array?{total:a.length,rows:a}:{total:0,rows:[]}}},rightColumns:[[{field:"id",checkbox:!0},{field:"ip",title:"IP",width:80,ellipsis:!0},{field:"showName",title:"设备名称",width:80,ellipsis:!0},{field:"typeName",title:"设备类型",width:80,
ellipsis:!0},{field:"instanceId",title:"核心设备",formatter:function(a,c){var d=$("<input name='core' type='radio'/>");d.data("instanceid",c.instanceId);d.on("click",function(a){$(this).prop("checked")&&(ctx.coreInstanceId=c.instanceId);a.stopPropagation()});c.instanceId==ctx.coreInstanceId&&d.prop("checked",!0);return d.get(0)}}]],selector:this.fields.pickGrid});this.leftGrid=this.pickgrid.leftGrid.selector;this.rightGrid=this.pickgrid.rightGrid.selector;oc.util.ajax({url:oc.resource.getUrl("topo/resource/all.htm"),
success:function(a){ctx.items=a;ctx.leftData=ctx.items;ctx.leftGrid.datagrid("loadData",ctx.leftData);ctx.args.onLoad.call(ctx)}});this.regEvent()},regEvent:function(){var a=this.fields,b=this;a.searchIpt.on("keyup",function(a){13==a.keyCode&&b.search()});a.searchBtn.on("click",function(){b.search()});a=this.root.find(".tree-arrow-right");a.unbind("click");a.on("click",function(){var a=b.leftGrid.datagrid("getSelections");b.setRightGridValue(a)})},search:function(){for(var a=this.fields.searchIpt.val(),
a=a.replace(/\./g,"\\."),a=new RegExp(a),b=[],c=0;c<this.items.length;c++){var d=this.items[c];(a.test(d.ip)||a.test(d.showName))&&b.push(d)}this.leftGrid.datagrid("loadData",b)},setRightGridValue:function(a){for(var b=this.rightGrid.datagrid("getRows"),c={},d=[],e=0;e<b.length;e++){var f=b[e];c[f.id]=!0;d.push(f)}for(e=0;e<a.length;e++)f=a[e],c[f.id]||d.push(f);this.rightGrid.datagrid("loadData",d)},getValue:function(){for(var a=this.rightGrid.datagrid("getRows"),b=[],c=0;c<a.length;c++)b.push(a[c].instanceId);
a=this.root.find("[name=core]:checked");if(1==a.length)return{coreInstanceId:a.data("instanceid"),ids:b};alert("请选择核心设备");throw"未选择核心设备";},setValue:function(a){if(a){for(var b=this.leftGrid.datagrid("getRows"),c={},d=0;d<b.length;d++)c[b[d].id]=b[d];b=[];for(d=0;d<a.ids.length;d++){var e=a.ids[d];c[e]&&b.push(c[e])}this.coreInstanceId=a.coreInstanceId;this.rightGrid.datagrid("loadData",b)}}};function TopoMapCountryList(a){var b=this;this.args=$.extend({onLoad:function(){},holder:null},a);if(this.args.holder)oc.util.ajax({url:oc.resource.getUrl("resource/module/topo/map/TopoMapCountryList.html"),success:function(a){b.init(a)},dataType:"html",type:"get"});else throw"bad arguments";}
TopoMapCountryList.prototype={init:function(a){this.root=$(a);this.root.appendTo(this.args.holder);this.fields={};var b=this;this.root.find("[data-field]").each(function(a,d){var e=$(d);b.fields[e.attr("data-field")]=e});this.regEvent();a=this.fields.template.find("img");a.attr("src",oc.resource.getUrl(a.attr("src")));this.args.onLoad.call(this)},regEvent:function(){},show:function(){this.root.show()},hide:function(){this.root.hide()},setValue:function(a){var b=this.fields;b.title.text(a.title);b.container.find(".list_item").remove();
if(a.nodes)for(var c=0;c<a.nodes.length;c++){var d=a.nodes[c],e=b.template.clone();e.removeClass("hide");e.addClass("list_item");e.find(".srcName").text(d.srcName);e.find(".srcName").attr({title:d.srcName});e.find(".desName").text(d.desName);e.find(".desName").attr({title:d.desName});e.find(".des_flag").addClass(d.desState);e.find(".src_flag").addClass(d.srcState);e.appendTo(b.container)}}};function TopoMapFlowList(a){this.args=$.extend({holder:null},a);var b=this;if(this.args.holder)oc.util.ajax({url:oc.resource.getUrl("resource/module/topo/map/TopoMapFlowList.html"),success:function(a){b.init(a)},type:"get",dataType:"html"});else throw"bad parameters";}
TopoMapFlowList.prototype={init:function(a){this.root=$(a);this.root.appendTo(this.args.holder);this.fields={};var b=this;this.root.find("[data-field]").each(function(a,d){var e=$(d);b.fields[e.attr("data-field")]=e});a=this.fields.flowItemTemplate.find("img");a.attr("src",oc.resource.getUrl(a.attr("src")));this.regEvent();this.toMap(1)},regEvent:function(){var a=this.fields,b=this;a.flowTitle.on("click",function(){a.flowBox.removeClass("hide");a.alarmBox.addClass("hide");a.flowTitle.addClass("hover");
a.alarmTitle.removeClass("hover")});a.alarmTitle.on("click",function(){a.alarmBox.removeClass("hide");a.flowBox.addClass("hide");a.alarmTitle.addClass("hover");a.flowTitle.removeClass("hover")});a.unavailableContainer.on("click",".unavailable_item",function(){var a=$(this).attr("data-next-mapid");a&&oc.module.topo.map.loadMapData(a,oc.topo.map.graph.level)});eve.on("topo.map.dbclick",function(a){b.toMap(a)})},show:function(){this.root.show()},hide:function(){this.root.hide()},toMap:function(a){oc.topo.map.util.beginLog("TopoMapFlowList.toMap");
if(!this.lastMapId||this.lastMapId!=a){var b=this;$.post(oc.resource.getUrl("topo/map/graph/flowlist.htm"),{mapid:a},function(a){200==a.status&&(b.setValue(a.info),oc.topo.map.util.endLog("TopoMapFlowList.toMap"))},"json")}this.lastMapId=a},setValue:function(a){var b=this.fields;b.monitorCount.text(a.monitorCount||0);b.available.text(a.available||0);b.unavailable.text(a.unavailable||0);b.unavailableContainer.find(".unavailable_item").remove();for(var c=0;c<a.unavailableNodes.length;c++){var d=a.unavailableNodes[c],
e=b.unavailableTemplate.clone();e.removeClass("hide");e.addClass("unavailable_item");e.find(".name").text(d.name);e.find(".ip").text(d.ip);e.attr("data-next-mapid",d.nextMapId);b.unavailableContainer.append(e)}b.flowContainer.find(".flow_item").remove();for(c=0;c<a.flowNodes.length;c++){d=a.flowNodes[c];e=b.flowItemTemplate.clone();e.removeClass("hide");e.addClass("flow_item");e.find(".index").text(c+1);var f=e.find(".srcName");f.text(d.srcName||"- -");f.attr("title",d.srcName||"- -");f=e.find(".desName");
f.text(d.desName||"- -");f.attr("title",d.desName||"- -");e.find(".flow_amount").text(d.flow);e.find(".flow_ratio").text(d.ratio);b.flowContainer.append(e)}}};SVG.extend(SVG.Element,{animateMotion:function(a){a=$.extend({dur:"10s",rotate:"auto",fill:"freeze",mpath:null},a);var b=$(document.createElementNS("http://www.w3.org/2000/svg","animateMotion"));if(a.mpath){var c=document.createElementNS("http://www.w3.org/2000/svg","mpath");c.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","#"+a.mpath);c=$(c);b.append(c);delete a.mpath;b.attr(a)}$(this.node).append(b)}});function TopoSvgElement(a){this.svg=a}
TopoSvgElement.prototype={createTag:function(a){return $(document.createElementNS("http://www.w3.org/2000/svg",a))},createStop:function(a){var b=this.createTag("stop");this.renderElement(b,a);return b},createRadialGradient:function(a){var b=this.createTag("radialGradient"),c=a.stops||[];delete a.stops;this.renderElement(b,a);for(a=0;a<c.length;a++)b.append(this.createStop(c[a]).get(0));return b},mask:function(a){var b=this.createTag("mask");this.renderElement(b,a);return b},circle:function(a){var b=
this.createTag("circle");this.renderElement(b,a);return b},g:function(a){var b=this.createTag("g");this.renderElement(b,a);return b},use:function(a){var b=this.createTag("use");this.renderElement(b,a);return b},renderElement:function(a,b){a.attr(b);a.removeAttr("style");a.css(b.style||{})},getUuid:function(){return Raphael.createUUID()}};function TopoMapMenu(a){this.args=$.extend({onLoad:function(){}},a);var b=this;oc.util.ajax({url:oc.resource.getUrl("resource/module/topo/map/TopoMapMenu.html"),success:function(a){b.init(a)},dataType:"html",type:"get"})}
TopoMapMenu.prototype={init:function(a){this.root=$(a);this.menus={};ctx=this;this.root.find("[data-field]").each(function(a,c){var d=$(c);ctx.menus[d.attr("data-field")]=d;d.menu()});this.initMenu()},initMenu:function(){this.initNodeMenu();this.initLineMenu()},initNodeMenu:function(){var a=this;this.menus.node.menu({onClick:function(b){var c=a.getNode(),d=c.data("db");switch(b.text){case "关联资源实例":oc.resource.loadScript("resource/module/topo/contextMenu/RelateResourceInstance.js",function(){new RelateResourceInstance({id:1,
instanceId:d?d.instanceId:null,onConfirm:function(){var a=this.getValue(),b=this;a&&oc.util.ajax({url:oc.resource.getUrl("topo/map/node/relateResourceInstance.htm"),data:{nodeid:c.data("id"),instanceId:a.instanceId,mapid:oc.topo.map.graph.getMapId(),nextMapId:oc.topo.map.graph.getMapIdForPoint(c),level:oc.topo.map.graph.level},success:function(d){if(200==d.status){alert(d.msg);b.root.dialog("close");var h={};h[a.instanceId]=[c];oc.topo.map.graph.refreshState([a.instanceId],[],h);oc.topo.map.graph.refreshHealthyStatus();
oc.topo.map.flowlist.lastMapId=null;c.data("db",d.node)}else alert(d.msg,"warning")}})}})});break;case "取消关联":oc.util.ajax({url:oc.resource.getUrl("topo/map/node/cancelRelateResourceInstance.htm"),data:{nodeid:c.data("id"),mapid:oc.topo.map.graph.getMapId()},success:function(a){200==a.status?(alert(a.msg),oc.topo.map.graph.setState(c,"none"),c.data("db",null)):alert(a.msg,"warning")}});break;case "下级资源管理":oc.resource.loadScript("resource/module/topo/map/TopoMapCountryInfo.js",function(){new TopoMapCountryInfo({onOk:function(){var a=
this.getValue(),b=this;$.post(oc.resource.getUrl("topo/map/node/updateAttr.htm"),{attr:JSON.stringify({country:a}),id:d.id},function(a){200==a.status?(alert(a.msg),b.root.dialog("close")):alert(a.msg,"warning")},"json")},onLoad:function(){var a=this;$.post(oc.resource.getUrl("topo/map/node/updateAttr.htm"),{attr:"{}",id:d.id},function(b){200==b.status?a.setValue(b.result.attrJson.country):alert(b.msg,"warning")},"json")}})})}}})},initLineMenu:function(){var a=this;this.menus.line.menu({onClick:function(b){var c=
a.getNode(),d=c.data("db"),e=oc.topo.map.graph.lines[c.attr("id")];switch(b.text){case "转为链路":oc.resource.loadScript("resource/module/topo/contextMenu/TopoAddLink.js",function(){var a=e.toNode,b=e.fromNode.data("db")||{},a=a.data("db")||{};new TopoAddLink({from:{d:{instanceId:b.instanceId,ip:b.ip}},to:{d:{instanceId:a.instanceId,ip:a.ip}},onOk:function(a){a.id=d.id;oc.util.ajax({url:oc.resource.getUrl("topo/map/line/convertToLink.htm"),data:{linkInfo:JSON.stringify(a)},success:function(a){if(200==
a.status){var b={};b[a.instanceId]=[e];oc.topo.map.graph.refreshState([],[a.instanceId],b);alert(a.msg)}else alert(a.msg,"warning")}})}})});break;case "删除":oc.util.ajax({url:oc.resource.getUrl("topo/map/line/remove.htm"),data:{id:d.id},success:function(a){200==a.status?(alert(a.msg),e.remove()):alert(a.msg,"warning")}});break;case "编辑链路":oc.resource.loadScript("resource/module/topo/contextMenu/EditLink.js",function(){new EditLinkDia({d:{instanceId:d.instanceId}})});break;case "详细信息":d.instanceId&&
oc.resource.loadScript("resource/module/topo/contextMenu/TopoLinkInfo.js",function(){oc.util.ajax({url:oc.resource.getUrl("topo/instanceTable/link/list.htm"),type:"GET",data:{resourceIds:d.instanceId,type:"map"},successMsg:null,success:function(a){new TopoLinkInfo(a)}})})}}})},getNode:function(){return this.node},show:function(a,b,c){var d=this.menus[a];this.node=c;c=this.node.data("db");if(d&&this.node){switch(a){case "node":a=d.menu("findItem","取消关联");var e=d.menu("findItem","下级资源管理");$(e.target).hide();
c&&c.instanceId?($(a.target).show(),(3==oc.topo.map.graph.level||oc.module.topo.map.isCharteredCities(oc.topo.map.graph.mapid))&&$(e.target).show()):$(a.target).hide();break;case "line":a=d.menu("findItem","转为链路");var e=d.menu("findItem","详细信息"),f=d.menu("findItem","编辑链路");c&&c.instanceId?($(a.target).hide(),$(e.target).show(),$(f.target).show()):($(a.target).show(),$(e.target).hide(),$(f.target).hide())}d.menu("show",{left:b.pageX,top:b.pageY})}return d}};function TopoUtil(){this.timeMap={}}TopoUtil.prototype={beginLog:function(a){this.timeMap[a]=(new Date).getTime()},endLog:function(a){var b=this.timeMap[a];b&&(console.log(a+"耗时:"+((new Date).getTime()-b)+"ms"),delete this.timeMap[a])}};
