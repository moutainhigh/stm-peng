
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link type="text/css"
	href="lib/jquery-ui-1.8.4.custom/css/smoothness/jquery-ui-1.8.4.custom.css"
	rel="stylesheet" />


<script type="text/javascript"
	src="lib/jquery-ui-1.8.4.custom/js/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="lib/raphael.js"></script>
<script type="text/javascript" src="lib/raphael-fn.js"></script>
<script type="text/javascript"
	src="lib/jquery-ui-1.8.4.custom/js/jquery-ui-1.8.4.custom.min.js"></script>
<script type="text/javascript" src="canvas.js"></script>
<script type="text/javascript">
	$(function() {
/**		init($("#myflow")[0],{
							basePath : "",
							//restore : eval("({states:{rect1:{type:'task',text:{text:'服务器B'}, attr:{ x:508, y:157, width:100, height:50}, props:{text:{value:'服务器B'},assignee:{value:''},form:{value:''},desc:{value:''}}},rect2:{type:'task',text:{text:'服务器C'}, attr:{ x:715, y:164, width:100, height:50}, props:{text:{value:'服务器C'},assignee:{value:''},form:{value:''},desc:{value:''}}},rect3:{type:'task',text:{text:'服务器E'}, attr:{ x:304, y:320, width:100, height:50}, props:{text:{value:'服务器E'},assignee:{value:''},form:{value:''},desc:{value:''}}},rect4:{type:'task',text:{text:'服务器F'}, attr:{ x:448, y:318, width:100, height:50}, props:{text:{value:'服务器F'},assignee:{value:''},form:{value:''},desc:{value:''}}},rect5:{type:'task',text:{text:'服务器G'}, attr:{ x:582, y:319, width:100, height:50}, props:{text:{value:'服务器G'},assignee:{value:''},form:{value:''},desc:{value:''}}},rect6:{type:'task',text:{text:'服务器H'}, attr:{ x:709, y:316, width:100, height:50}, props:{text:{value:'服务器H'},assignee:{value:''},form:{value:''},desc:{value:''}}},rect7:{type:'task',text:{text:'服务器I'}, attr:{ x:845, y:317, width:100, height:50}, props:{text:{value:'服务器I'},assignee:{value:''},form:{value:''},desc:{value:''}}},rect8:{type:'task',text:{text:'服务器D'}, attr:{ x:172, y:320, width:100, height:50}, props:{text:{value:'服务器D'},assignee:{value:''},form:{value:''},desc:{value:''}}},rect9:{type:'task',text:{text:'服务器J'}, attr:{ x:976, y:319, width:100, height:50}, props:{text:{value:'服务器J'},assignee:{value:''},form:{value:''},desc:{value:''}}},rect10:{type:'task',text:{text:'服务器K'}, attr:{ x:1156, y:322, width:100, height:50}, props:{text:{value:'服务器K'},assignee:{value:''},form:{value:''},desc:{value:''}}},rect11:{type:'task',text:{text:'服务器A'}, attr:{ x:509, y:39, width:100, height:50}, props:{text:{value:'服务器A'},assignee:{value:''},form:{value:''},desc:{value:''}}},rect12:{type:'task',text:{text:'服务器L'}, attr:{ x:583, y:434, width:100, height:50}, props:{text:{value:'服务器L'},assignee:{value:''},form:{value:''},desc:{value:''}}},rect13:{type:'task',text:{text:'服务器M'}, attr:{ x:420, y:545, width:100, height:50}, props:{text:{value:'服务器M'},assignee:{value:''},form:{value:''},desc:{value:''}}},rect14:{type:'task',text:{text:'服务器N'}, attr:{ x:741, y:543, width:100, height:50}, props:{text:{value:'服务器N'},assignee:{value:''},form:{value:''},desc:{value:''}}}},paths:{path15:{from:'rect11',to:'rect1', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path16:{from:'rect1',to:'rect8', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path17:{from:'rect1',to:'rect3', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path18:{from:'rect1',to:'rect4', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path19:{from:'rect1',to:'rect5', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path20:{from:'rect1',to:'rect6', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path21:{from:'rect1',to:'rect7', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path22:{from:'rect1',to:'rect9', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path23:{from:'rect1',to:'rect10', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path24:{from:'rect2',to:'rect10', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path25:{from:'rect2',to:'rect9', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path26:{from:'rect2',to:'rect7', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path27:{from:'rect2',to:'rect6', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path28:{from:'rect2',to:'rect5', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path29:{from:'rect2',to:'rect4', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path30:{from:'rect2',to:'rect3', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path31:{from:'rect2',to:'rect8', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path32:{from:'rect5',to:'rect12', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path33:{from:'rect12',to:'rect13', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path34:{from:'rect12',to:'rect14', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path35:{from:'rect4',to:'rect12', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path36:{from:'rect6',to:'rect12', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path37:{from:'rect3',to:'rect12', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path38:{from:'rect8',to:'rect12', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path39:{from:'rect7',to:'rect12', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path40:{from:'rect9',to:'rect12', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path41:{from:'rect10',to:'rect12', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}}},props:{props:{name:{value:'新建流程'},key:{value:''},desc:{value:''}}}})"),
							restore:eval("({states:{rect1:{type:'start',text:{text:'路由'}, attr:{ x:560, y:99, width:50, height:50}, props:{text:{value:'路由'},temp1:{value:''},temp2:{value:''}}},rect2:{type:'fork',text:{text:'不可用'}, attr:{ x:328, y:204, width:50, height:50}, props:{text:{value:'不可用'},temp1:{value:''},temp2:{value:''}}},rect3:{type:'join',text:{text:'警告'}, attr:{ x:812, y:149, width:50, height:50}, props:{text:{value:'警告'},temp1:{value:''},temp2:{value:''}}},rect4:{type:'state',text:{text:'交换机'}, attr:{ x:392, y:402, width:50, height:50}, props:{text:{value:'交换机'},temp1:{value:''},temp2:{value:''}}},rect5:{type:'task',text:{text:'危险'}, attr:{ x:724, y:355, width:50, height:50}, props:{text:{value:'危险'},assignee:{value:''},form:{value:''},desc:{value:''}}}},paths:{path6:{from:'rect1',to:'rect3', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path7:{from:'rect3',to:'rect5', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path8:{from:'rect5',to:'rect4', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path9:{from:'rect4',to:'rect2', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path10:{from:'rect2',to:'rect1', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path11:{from:'rect4',to:'rect1', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path12:{from:'rect1',to:'rect5', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path13:{from:'rect5',to:'rect2', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path14:{from:'rect2',to:'rect3', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}},path15:{from:'rect3',to:'rect4', dots:[],text:{text:''},textPos:{x:0,y:-10}, props:{text:{value:''}}}},props:{props:{name:{value:'新建流程'},key:{value:''},desc:{value:''}}}})"),
							tools : {
								save : {
									onclick : function(data) {
										alert('save:\n' + data);
									}
								}
							}
						});*/
/**		a = {};
		a.aaa = 23;
		a.bbb = "rfgdg";
		a.ccc = 67890;
		var tt = {abd:"asdfsfs",ioasd:56789}
		var obj = new Object();
		a.obj = obj;
		tt.obj = obj;
		delete tt.obj;
		a.ddd = tt;
		a.ddd.a = 90;
		a[3] = 9;
		delete a["sdsrghf"];
		alert("as length is "+sizeof(a))
		invoke(aaa(1));
		function invoke(a){
			if(a) a();
		}
		function aaa(a){
			alert(a);
		}
		function sizeof(a){
			var s = 0;
			for(var i in a){
				s++;
			}
			return s;
		}
		function Obj(){
			this.id = 0x345678;
			this.f = function(){
				alert(this.id);
			}
			alert("waimian");
		}
		new Obj().f();
		alert(JSON.stringify(a))
		*/
		function sizeof(a){
			var s = 0;
			for(var i in a){
				s++;
			}
			return s;
		}
		var containerJSON = {containers:[{x:500,y:350,w:65,h:80,
//			handler:{rx:0,ry:0,w:65,h:50},
			texts:[{text:"192.168.2.12",rx:32.5,ry:75,type:"text_ip",attr:{"stroke":"white"}}],
			imgs:[{src:"img/top/router.png",type:"img_bg",rx:0,ry:0,w:65,h:65}]}]}
						
		var canvas = $("#myflow").canvas({a:10});
		var container = canvas.container(500,50,710,500);
		container.addText(canvas.raphael.text(0, 0,"设备管理").attr({"font-size": 18,fill:"white"}),355,25);
		container.frame.attr({"stroke-width": 1,stroke:"white"})	
		container.handler.attr({"stroke-width": 1,stroke:"white"})
		container.setHandler({rx:0,ry:0,attr:{height:50,width:710,"fill-opacity":0.5,fill:"green"}});
		canvas.container(200,400,65,100).set(containerJSON.containers[0]);
		
		$("#myflow_tools .state").each(function() {
                $(this).draggable({
					//拖拽的时候拖拽实体为克隆对象
                    helper: "clone"
                })
        });
		$("#myflow_tools").draggable({
                handle: "#myflow_tools_handle"
            }).css({left:10,top:10});
            $("#myflow_tools .node").hover(function() {
                $(this).addClass("mover")
            },
            function() {
                $(this).removeClass("mover")
        });
		$("#myflow").droppable({
                accept: ".state",
                drop: function(c, i) {
					containerJSON.containers[0].imgs[0].src = i.helper.find("img").attr("src");
					containerJSON.containers[0].texts[0].text = i.helper.text();
					container.addContainer(canvas.container(i.helper.offset().left,i.helper.offset().top,65,80).set(containerJSON.containers[0])
//					.addText(canvas.raphael.text(0, 0,"交换机"),55,150)
//					.addImg(canvas.raphael.image("zj2.png", 0, 0, 110, 140), 0, 0)
//					.addImg(canvas.raphael.image("start_event_empty.png", 0, 0, 40, 50), 0, 100)
//					.addImg(canvas.raphael.image("start_event_empty.png", 70, 0, 40, 50), 70, 100)					
//					.ready(0,0,110,20)
					,i.helper.offset().left-container.x,i.helper.offset().top-container.y);
					//canvas.rect(i.helper.offset().left,i.helper.offset().top);
                }
            });
		$("#myflow_save").click(function(){
			var data = canvas.getData();
//			alert(sizeof(canvas.topContainers)+"   "+sizeof(canvas.containers));
			alert(data)
			canvas.raphael.clear();
			canvas.restore(eval("("+data+")"))
		})
		canvas.click = function(node){
			if(node == container) return;
			if(this.clickNode != null){
				this.clickNode.frame.attr({"stroke-width":0})
				if(this.isEditable){
					var line = this.onLine(this.clickNode,node)
//					if(line) line.animate();
				}			
			}
			node.frame.attr({"stroke-width":1})
			this.clickNode = node;
		}
		$("#path").click(function(){
			$(this).toggleClass("selected");
			canvas.isEditable = canvas.isEditable?false:true;
		})
		/**
		var pper = Raphael("myflow",1000,1000);
		pper.arrow({x:200,y:200},{x:250,y:300},{x:300,y:200},{stroke:"#808080",fill:"#808080","stroke-width":"2"}).red().green()
		pper.turn();
		pper.polic(300,500,10);
		pper.polic(350,500,10);
		pper.polic(300,450,10);
		pper.polic(350,450,10);*/
	});
</script>
<style type="text/css">
body {
	margin: 0;
	pading: 0;
	text-align: left;
	font-family: Arial, sans-serif, Helvetica, Tahoma;
	font-size: 12px;
	line-height: 1.5;
	color: black;
	background-image: url(bg.png);
}

.node {
	width: 70px;
	text-align: center;
	vertical-align: middle;
	border: 1px solid #fff;
	cursor:url('img/16/gateway_parallel.png')
}

.mover {
	border: 1px solid #ddd;
	background-color: #ddd;
}

.selected {
	background-color: #ddd;
}

.state {
	
}

#myflow_props table {
	
}

#myflow_props th {
	letter-spacing: 2px;
	text-align: left;
	padding: 6px;
	background: #ddd;
}

#myflow_props td {
	background: #fff;
	padding: 6px;
}

#pointer {
	background-repeat: no-repeat;
	background-position: center;
}

#path {
	background-repeat: no-repeat;
	background-position: center;
}

#task {
	background-repeat: no-repeat;
	background-position: center;
}

#state {
	background-repeat: no-repeat;
	background-position: center;
}
</style>
</head>
<body>
<div id="myflow"></div>
<div id="myflow_tools"
	style="position: absolute; top: 10; left: 10; background-color: #fff; width: 70px; cursor: default; padding: 3px;"
	class="ui-widget-content">
<div id="myflow_tools_handle" style="text-align: center;"
	class="ui-widget-header">工具集</div>


<div class="node" id="myflow_save"><img src="img/save.gif" />&nbsp;&nbsp;保存</div>
<div>
<hr />
</div>
<div class="node selectable" id="pointer"><img
	src="img/select16.gif" />&nbsp;&nbsp;选择</div>
<div class="node selectable" id="path"><img
	src="img/16/flow_sequence.png" />&nbsp;&nbsp;连接</div>
<div>
<hr />
</div>
<div class="node state" id="start" type="start"><img
	src="img/top/router.png" width="16" height="16"/>&nbsp;&nbsp;路由</div>
<div class="node state" id="state" type="state"><img
	src="img/top/switch.png" width="16" height="16"/>&nbsp;&nbsp;交换机</div>
<div class="node state" id="task" type="task"><img
	src="img/top/switch_danger.png"  width="16" height="16"/>&nbsp;&nbsp;危险</div>
<div class="node state" id="fork" type="fork"><img
	src="img/top/switch_unable.png"  width="16" height="16"/>&nbsp;&nbsp;不可用</div>
<div class="node state" id="join" type="join"><img
	src="img/top/switch_waring.png"  width="16" height="16"/>&nbsp;&nbsp;警告</div>
<div class="node state" id="end" type="end"><img
	src="img/16/end_event_terminate.png" />&nbsp;&nbsp;结束</div>
<div class="node state" id="end-cancel" type="end-cancel"><img
	src="img/16/end_event_cancel.png" />&nbsp;&nbsp;取消</div>
<div class="node state" id="end-error" type="end-error"><img
	src="img/16/end_event_error.png" />&nbsp;&nbsp;错误</div>
</div>

<div id="myflow_props"
	style="position: absolute; top: 30; right: 50; background-i: #fff; width: 220px; padding: 3px;"
	class="ui-widget-content">
<div id="myflow_props_handle" class="ui-widget-header">属性</div>
<table border="1" width="100%" cellpadding="0" cellspacing="0">
	<tr>
		<td>aaa</td>
	</tr>
	<tr>
		<td>aaa</td>
	</tr>
</table>
<div>&nbsp;</div>
</div>


</body>
</html>